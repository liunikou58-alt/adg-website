(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,29205,e=>{"use strict";var t=e.i(43476),s=e.i(37902),l=e.i(71645),a=e.i(61946),r=e.i(18393),i=e.i(21218),o=e.i(40160),n=e.i(7233),d=e.i(75254);let c=(0,d.default)("trash-2",[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]]),x=(0,d.default)("move",[["path",{d:"M12 2v20",key:"t6zp3m"}],["path",{d:"m15 19-3 3-3-3",key:"11eu04"}],["path",{d:"m19 9 3 3-3 3",key:"1mg7y2"}],["path",{d:"M2 12h20",key:"9i4pu4"}],["path",{d:"m5 9-3 3 3 3",key:"j64kie"}],["path",{d:"m9 5 3-3 3 3",key:"l8vdw6"}]]),h=(0,d.default)("maximize",[["path",{d:"M8 3H5a2 2 0 0 0-2 2v3",key:"1dcmit"}],["path",{d:"M21 8V5a2 2 0 0 0-2-2h-3",key:"1e4gt3"}],["path",{d:"M3 16v3a2 2 0 0 0 2 2h3",key:"wsl5sc"}],["path",{d:"M16 21h3a2 2 0 0 0 2-2v-3",key:"18trek"}]]);var m=e.i(39312);let p=(0,d.default)("panels-top-left",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M3 9h18",key:"1pudct"}],["path",{d:"M9 21V9",key:"1oto5p"}]]);var b=e.i(78583),u=e.i(63059);let g=(0,d.default)("dollar-sign",[["line",{x1:"12",x2:"12",y1:"2",y2:"22",key:"7eqyqh"}],["path",{d:"M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6",key:"1b0p4s"}]]);var f=e.i(67240),j=e.i(54922),v=e.i(69638);let y=(0,d.default)("mouse-pointer-2",[["path",{d:"M4.037 4.688a.495.495 0 0 1 .651-.651l16 6.5a.5.5 0 0 1-.063.947l-6.124 1.58a2 2 0 0 0-1.438 1.435l-1.579 6.126a.5.5 0 0 1-.947.063z",key:"edeuup"}]]);var N=e.i(66992);let w=(0,d.default)("file-down",[["path",{d:"M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z",key:"1oefj6"}],["path",{d:"M14 2v5a1 1 0 0 0 1 1h5",key:"wfsgrz"}],["path",{d:"M12 18v-6",key:"17g6i2"}],["path",{d:"m9 15 3 3 3-3",key:"1npd3o"}]]),k=(0,d.default)("upload",[["path",{d:"M12 3v12",key:"1x0j5s"}],["path",{d:"m17 8-5-5-5 5",key:"7q97r8"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}]]);var M=e.i(73708);let S=(0,d.default)("map",[["path",{d:"M14.106 5.553a2 2 0 0 0 1.788 0l3.659-1.83A1 1 0 0 1 21 4.619v12.764a1 1 0 0 1-.553.894l-4.553 2.277a2 2 0 0 1-1.788 0l-4.212-2.106a2 2 0 0 0-1.788 0l-3.659 1.83A1 1 0 0 1 3 19.381V6.618a1 1 0 0 1 .553-.894l4.553-2.277a2 2 0 0 1 1.788 0z",key:"169xi5"}],["path",{d:"M15 5.764v15",key:"1pn4in"}],["path",{d:"M9 3.236v15",key:"1uimfh"}]]),C=(0,d.default)("wand-sparkles",[["path",{d:"m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72",key:"ul74o6"}],["path",{d:"m14 7 3 3",key:"1r5n42"}],["path",{d:"M5 6v4",key:"ilb8ba"}],["path",{d:"M19 14v4",key:"blhpug"}],["path",{d:"M10 2v2",key:"7u0qdc"}],["path",{d:"M7 8H3",key:"zfb6yr"}],["path",{d:"M21 16h-4",key:"1cnmox"}],["path",{d:"M11 3H9",key:"1obp7u"}]]);var P=e.i(37727);let I=(0,d.default)("undo",[["path",{d:"M3 7v6h6",key:"1v2h90"}],["path",{d:"M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13",key:"1r6uu6"}]]),z=(0,d.default)("redo",[["path",{d:"M21 7v6h-6",key:"3ptur4"}],["path",{d:"M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3l3 2.7",key:"1kgawr"}]]),R=(0,d.default)("waves",[["path",{d:"M2 6c.6.5 1.2 1 2.5 1C7 7 7 5 9.5 5c2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1",key:"knzxuh"}],["path",{d:"M2 12c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1",key:"2jd2cc"}],["path",{d:"M2 18c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1",key:"rd2r6e"}]]),D=(0,d.default)("ruler",[["path",{d:"M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L2.7 8.7a2.41 2.41 0 0 1 0-3.4l2.6-2.6a2.41 2.41 0 0 1 3.4 0Z",key:"icamh8"}],["path",{d:"m14.5 12.5 2-2",key:"inckbg"}],["path",{d:"m11.5 9.5 2-2",key:"fmmyf7"}],["path",{d:"m8.5 6.5 2-2",key:"vc6u1g"}],["path",{d:"m17.5 15.5 2-2",key:"wo5hmg"}]]),$=(0,d.default)("minimize",[["path",{d:"M8 3v3a2 2 0 0 1-2 2H3",key:"hohbtr"}],["path",{d:"M21 8h-3a2 2 0 0 1-2-2V3",key:"5jw1f3"}],["path",{d:"M3 16h3a2 2 0 0 1 2 2v3",key:"198tvr"}],["path",{d:"M16 21v-3a2 2 0 0 1 2-2h3",key:"ph8mxp"}]]),T=(0,d.default)("circle-x",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]]),q=(0,d.default)("camera",[["path",{d:"M13.997 4a2 2 0 0 1 1.76 1.05l.486.9A2 2 0 0 0 18.003 7H20a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h1.997a2 2 0 0 0 1.759-1.048l.489-.904A2 2 0 0 1 10.004 4z",key:"18u6gg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]]),A=(0,d.default)("chevron-left",[["path",{d:"m15 18-6-6 6-6",key:"1wnfg3"}]]);var F=e.i(15713),L=e.i(33499);let E=F.SI_DB,W=F.DEVICE_CATEGORIES,_=e=>new Intl.NumberFormat("zh-TW",{style:"currency",currency:"TWD",minimumFractionDigits:0}).format(e),B={"Main PA":"主擴聲 (Main)",Subwoofer:"超低音 (Sub)","Stage Monitor":"舞台監聽 (Monitor)","Front Fill":"前補聲 (Front Fill)",Delay:"延遲補聲 (Delay)",BGM:"背景音樂 (BGM)"},O=()=>{let[e,a]=(0,l.useState)([]);return(0,l.useEffect)(()=>{a([...Array(20)].map(()=>({top:100*Math.random(),left:100*Math.random(),size:4*Math.random()+2,duration:10*Math.random()+10,delay:-(10*Math.random())})))},[]),(0,t.jsxs)("div",{className:"jsx-df63372ea1fa1bb0 fixed inset-0 z-0 pointer-events-none overflow-hidden",children:[(0,t.jsx)("div",{className:"jsx-df63372ea1fa1bb0 absolute inset-0 bg-gradient-to-b from-slate-950 via-[#0a0f1e] to-slate-950"}),(0,t.jsx)("div",{style:{backgroundImage:"linear-gradient(rgba(249, 115, 22, 0.3) 1px, transparent 1px), linear-gradient(90deg, rgba(249, 115, 22, 0.3) 1px, transparent 1px)",backgroundSize:"100px 100px",transform:"perspective(500px) rotateX(60deg) translateY(-100px) scale(3)",transformOrigin:"top center",animation:"grid-move 20s linear infinite"},className:"jsx-df63372ea1fa1bb0 absolute inset-0 opacity-20"}),(0,t.jsx)("div",{className:"jsx-df63372ea1fa1bb0 absolute top-0 left-0 w-full h-full",children:e.map((e,s)=>(0,t.jsx)("div",{style:{top:`${e.top}%`,left:`${e.left}%`,width:`${e.size}px`,height:`${e.size}px`,animation:`float-particle ${e.duration}s linear infinite`,animationDelay:`${e.delay}s`},className:"jsx-df63372ea1fa1bb0 absolute bg-orange-500/30 rounded-full blur-md"},s))}),(0,t.jsx)(s.default,{id:"df63372ea1fa1bb0",children:"@keyframes grid-move{0%{background-position:0 0}to{background-position:0 100px}}@keyframes float-particle{0%{transform:translateY(0)opacity(0)}50%{opacity:.8}to{transform:translateY(-100vh)opacity(0)}}"})]})};function H(){let{t:e}=(0,L.useI18n)(),[s,r]=(0,l.useState)(1),[o,n]=(0,l.useState)([]),[d,c]=(0,l.useState)({name:"新建多功能廳視聽工程",date:new Date().toISOString().split("T")[0],presenter:"",company:"",roomWidth:20,roomDepth:15,isCalibrated:!1,bgImage:null,simSnapshots:[],bom:[]}),[x,h]=(0,l.useState)([]),[m,u]=(0,l.useState)({margin:20,taxRate:5,laborDays:2,laborPrice:8e3,consumablesRate:3});(0,l.useEffect)(()=>{let e=localStorage.getItem("si-engine-save");if(e)try{let t=JSON.parse(e);n(t.bom||[]),c(t.projectInfo||d),h(t.canvasObjects||[])}catch(e){console.error(e)}},[]),(0,l.useEffect)(()=>{try{localStorage.setItem("si-engine-save",JSON.stringify({bom:o,projectInfo:d,canvasObjects:x}))}catch(e){console.warn("Storage quota exceeded, failed to auto-save project.",e)}},[o,d,x]),o.reduce((e,t)=>e+t.unitPrice*t.qty,0);let{lang:f,setLang:j}=(0,L.useI18n)();return(0,t.jsxs)("div",{className:"min-h-screen bg-slate-950 text-slate-100 font-sans selection:bg-orange-500 selection:text-white pb-20 pt-16 relative",children:[(0,t.jsx)(O,{}),6!==s&&(0,t.jsxs)("div",{className:"bg-slate-950 border-b border-slate-800 p-4 flex justify-between items-center sticky top-0 z-40 shadow-lg",children:[(0,t.jsxs)("div",{className:"flex items-center gap-4",children:[(0,t.jsx)("div",{className:"bg-gradient-to-br from-orange-500 to-red-600 p-2 rounded-lg shadow-[0_0_15px_rgba(249,115,22,0.5)]",children:(0,t.jsx)(N.Cpu,{className:"text-white",size:24})}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h1",{className:"text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400 font-orbitron tracking-wider",children:"SI ENGINE PRO"}),(0,t.jsx)("p",{className:"text-xs text-orange-500 font-bold tracking-[0.2em]",children:e("si.subtitle")})]})]}),(0,t.jsx)("div",{className:"flex gap-2",children:[1,2,3,4,5,6].map(l=>(0,t.jsxs)("button",{onClick:()=>r(l),className:`px-4 py-2 rounded-full text-xs font-bold transition-all border outline-none flex items-center ${s===l?"bg-orange-600 border-orange-500 text-white shadow-[0_0_10px_rgba(234,88,12,0.4)]":"border-slate-800 text-slate-600 bg-slate-900 hover:border-slate-600"}`,children:[1===l&&(0,t.jsx)(S,{size:14,className:"mr-1"}),2===l&&(0,t.jsx)(a.Speaker,{size:14,className:"mr-1"}),3===l&&(0,t.jsx)(p,{size:14,className:"mr-1"}),4===l&&(0,t.jsx)(i.Activity,{size:14,className:"mr-1"}),5===l&&(0,t.jsx)(g,{size:14,className:"mr-1"}),6===l&&(0,t.jsx)(b.FileText,{size:14,className:"mr-1"}),1===l&&e("si.phase.1"),2===l&&e("si.phase.2"),3===l&&e("si.phase.3"),4===l&&e("si.phase.4"),5===l&&e("si.phase.5"),6===l&&"工程報表"]},l))}),(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("div",{className:"flex bg-slate-800 rounded-lg p-1 border border-slate-700 mr-2",children:["zh-TW","zh-CN","en"].map(e=>(0,t.jsx)("button",{onClick:()=>j(e),className:`px-3 py-1 text-xs font-bold rounded-md transition-all ${f===e?"bg-orange-600 text-white shadow-sm":"text-slate-400 hover:text-white hover:bg-white/5"} `,children:"zh-TW"===e?"繁":"zh-CN"===e?"简":"EN"},e))}),(0,t.jsx)("div",{className:"px-3 py-1 bg-black/40 rounded border border-slate-700",children:(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("div",{className:`w-2 h-2 rounded-full ${d.roomWidth>0?"bg-green-500 shadow-[0_0_5px_#22c55e]":"bg-red-500 animate-pulse"}`}),(0,t.jsx)("span",{className:"text-xs font-mono text-slate-400 font-bold",children:d.isCalibrated?"READY":"WAITING"})]})})]})]}),(0,t.jsxs)("main",{className:"max-w-[1600px] mx-auto px-2 md:px-4 py-6 relative z-10 transition-all duration-500 ease-in-out",children:[1===s&&(0,t.jsx)(G,{projectInfo:d,setProjectInfo:c,setPhase:r,t:e}),2===s&&(0,t.jsx)(U,{bom:o,setBom:n,projectInfo:d,setCanvasObjects:h,setPhase:r,t:e}),3===s&&(0,t.jsx)(V,{bom:o,projectInfo:d,setProjectInfo:c,canvasObjects:x,setCanvasObjects:h,setPhase:r,t:e}),4===s&&(0,t.jsx)(X,{bom:o,projectInfo:d,setPhase:r,t:e}),5===s&&(0,t.jsx)(Q,{bom:o,reportSettings:m,setReportSettings:u,setPhase:r,t:e}),6===s&&(0,t.jsx)(K,{projectInfo:d,setProjectInfo:c,bom:o,setBom:n,reportSettings:m,setPhase:r,canvasObjects:x})]})]})}function G({projectInfo:e,setProjectInfo:s,setPhase:a,t:r}){let i=(0,l.useRef)(null),o=(0,l.useRef)(null),n=(0,l.useRef)(null),[d,x]=(0,l.useState)(!1),[h,m]=(0,l.useState)([]),[p,b]=(0,l.useState)("5"),[g,f]=(0,l.useState)(!1);return(0,t.jsxs)("div",{className:"max-w-3xl mx-auto space-y-6 animate-in slide-in-from-bottom-4 fade-in",children:[(0,t.jsxs)("div",{className:"bg-slate-900/80 backdrop-blur border border-slate-700 p-6 rounded-xl",children:[(0,t.jsxs)("h2",{className:"text-xl font-bold text-white mb-6 flex items-center gap-2",children:[(0,t.jsx)(S,{className:"text-orange-400"})," ",r("si.project.title")]}),(0,t.jsxs)("div",{className:"space-y-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-slate-400 text-sm mb-1",children:r("si.project.name")}),(0,t.jsx)("input",{className:"w-full bg-black/50 border border-slate-700 rounded p-2 text-white",value:e.name,onChange:t=>s({...e,name:t.target.value})})]}),(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-slate-400 text-sm mb-1",children:r("si.project.width")}),(0,t.jsx)("input",{type:"number",className:"w-full bg-black/50 border border-slate-700 rounded p-2 text-white",value:e.roomWidth,onChange:t=>s({...e,roomWidth:Number(t.target.value)})})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"block text-slate-400 text-sm mb-1",children:r("si.project.depth")}),(0,t.jsx)("input",{type:"number",className:"w-full bg-black/50 border border-slate-700 rounded p-2 text-white",value:e.roomDepth,onChange:t=>s({...e,roomDepth:Number(t.target.value)})})]})]})]})]}),(0,t.jsxs)("div",{className:"bg-slate-900/80 backdrop-blur border border-slate-700 p-6 rounded-xl",children:[(0,t.jsxs)("h2",{className:"text-xl font-bold text-white mb-4",children:[(0,t.jsx)(M.Image,{className:"text-orange-400 inline mr-2"})," ",r("si.project.floorplan")]}),e.bgImage?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:`relative group rounded-lg overflow-hidden border border-slate-700 bg-black flex items-center justify-center ${d?"cursor-crosshair":""}`,children:[(0,t.jsxs)("div",{className:"relative w-full h-full flex items-center justify-center",ref:o,children:[(0,t.jsx)("img",{ref:n,src:e.bgImage,className:"max-w-full max-h-[600px] w-auto h-auto object-contain pointer-events-auto select-none",onClick:e=>{if(!d||!o.current)return;let t=o.current.getBoundingClientRect(),s=[...h,{x:e.clientX-t.left,y:e.clientY-t.top}];m(s),2===s.length&&f(!0)},draggable:!1}),d&&(0,t.jsxs)("div",{className:"absolute top-0 left-0 w-full h-full pointer-events-none",children:[h.map((e,s)=>(0,t.jsx)("div",{className:"absolute w-3 h-3 bg-red-500 rounded-full border border-white -translate-x-1.5 -translate-y-1.5 shadow-sm",style:{left:e.x,top:e.y}},s)),2===h.length&&(0,t.jsx)("svg",{className:"absolute top-0 left-0 w-full h-full pointer-events-none overflow-visible",children:(0,t.jsx)("line",{x1:h[0].x,y1:h[0].y,x2:h[1].x,y2:h[1].y,stroke:"red",strokeWidth:2,strokeDasharray:"5,5"})})]})]}),!d&&(0,t.jsx)("button",{onClick:()=>s({...e,bgImage:null}),className:"absolute top-2 right-2 bg-red-600/80 p-2 rounded text-white opacity-0 group-hover:opacity-100 transition-opacity z-10",children:(0,t.jsx)(c,{size:16})}),g&&(0,t.jsx)("div",{className:"absolute inset-0 bg-black/80 flex items-center justify-center z-20",children:(0,t.jsxs)("div",{className:"bg-slate-900 border border-indigo-500 p-6 rounded-xl shadow-2xl flex flex-col gap-4 animate-in zoom-in",children:[(0,t.jsx)("h3",{className:"font-bold text-white text-lg",children:r("si.project.scale.title")}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"text-xs text-slate-400 mb-1 block",children:r("si.calibration.label")}),(0,t.jsx)("input",{type:"number",autoFocus:!0,className:"w-full bg-black border border-slate-600 rounded p-2 text-white text-lg font-mono focus:border-indigo-500 outline-none",value:p,onChange:e=>b(e.target.value),onFocus:e=>e.target.select()})]}),(0,t.jsxs)("div",{className:"flex gap-2",children:[(0,t.jsx)("button",{onClick:()=>{x(!1),m([]),f(!1)},className:"flex-1 px-4 py-2 bg-slate-800 rounded text-slate-300 hover:bg-slate-700",children:r("si.calibration.cancel")}),(0,t.jsx)("button",{onClick:()=>{if(2!==h.length||!n.current)return;let t=h[0],l=h[1],a=Math.sqrt(Math.pow(l.x-t.x,2)+Math.pow(l.y-t.y,2))/(parseFloat(p)||5),r=n.current.clientWidth,i=n.current.clientHeight;s({...e,roomWidth:parseFloat((r/a).toFixed(2)),roomDepth:parseFloat((i/a).toFixed(2)),isCalibrated:!0}),x(!1),m([]),f(!1)},className:"flex-1 px-4 py-2 bg-indigo-600 rounded text-white font-bold hover:bg-indigo-500",children:r("si.calibration.confirm")})]})]})})]}),(0,t.jsxs)("div",{className:"flex justify-end items-center mt-2 gap-4",children:[e.isCalibrated?(0,t.jsxs)("div",{className:"flex items-center gap-1 text-green-400 text-sm font-bold animate-in fade-in slide-in-from-right-4",children:[(0,t.jsx)(v.CheckCircle,{size:16})," ",r("si.calibration.set")]}):(0,t.jsxs)("div",{className:"flex items-center gap-1 text-red-400 text-sm font-bold animate-in fade-in slide-in-from-right-4",children:[(0,t.jsx)(T,{size:16})," ",r("si.calibration.notset")]}),d?(0,t.jsx)("button",{onClick:()=>x(!1),className:"bg-red-600/20 hover:bg-red-600/40 text-red-200 px-4 py-2 rounded-lg text-sm font-bold border border-red-600/50",children:r("si.calibration.btn.cancel")}):(0,t.jsxs)("button",{onClick:()=>{x(!0),m([])},className:"bg-slate-800 hover:bg-indigo-600 hover:text-white text-slate-400 px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 border border-slate-700 transition-colors",children:[(0,t.jsx)(D,{size:16})," ",r("si.project.scale.btn")]})]})]}):(0,t.jsxs)("div",{className:"border-2 border-dashed border-slate-600 rounded-xl p-10 flex flex-col items-center justify-center text-slate-400 hover:border-orange-500 cursor-pointer hover:bg-white/5",onClick:()=>i.current?.click(),children:[(0,t.jsx)(k,{size:48,className:"mb-4"}),(0,t.jsx)("p",{children:r("si.upload.floor")}),(0,t.jsx)("input",{type:"file",ref:i,className:"hidden",accept:"image/*",onChange:t=>{let l=t.target.files?.[0];if(l){let t=new FileReader;t.onload=t=>s({...e,bgImage:t.target?.result}),t.readAsDataURL(l)}}})]})]}),(0,t.jsx)("div",{className:"fixed bottom-8 right-8 z-50",children:(0,t.jsxs)("button",{onClick:()=>a(2),className:"bg-orange-600 hover:bg-orange-500 text-white pl-6 pr-4 py-4 rounded-full font-bold shadow-2xl flex gap-2",children:[r("si.project.next")," ",(0,t.jsx)(u.ChevronRight,{})]})})]})}function U({bom:e,setBom:s,projectInfo:a,setCanvasObjects:r,setPhase:i,t:o}){let[n,d]=(0,l.useState)(W[0]),[x,h]=(0,l.useState)("Main PA"),[p,b]=(0,l.useState)(""),[g,f]=(0,l.useState)(""),[j,v]=(0,l.useState)(null),[y,N]=(0,l.useState)(1),[k,M]=(0,l.useState)(0),S=E[n.dbKey]||[],C=Array.from(new Set(S.map(e=>e.brand))),P=Array.from(new Set(S.filter(e=>e.brand===p).map(e=>e.series||""))),I=S.filter(e=>e.brand===p&&(!g||e.series===g));return(0,l.useEffect)(()=>{b(""),f(""),v(null),M(0)},[n]),(0,l.useEffect)(()=>{p&&1===P.length?f(P[0]):f("")},[p]),(0,l.useEffect)(()=>{1===I.length?v(I[0]):I.length>0&&!I.find(e=>e.model===j?.model)&&v(null)},[I]),(0,t.jsxs)("div",{className:"space-y-4 animate-in slide-in-from-right-4 fade-in",children:[(0,t.jsxs)("div",{className:"flex gap-2 mb-2 overflow-x-auto pb-2 no-scrollbar",children:[(0,t.jsxs)("button",{onClick:()=>{confirm(o("si.confirm.reset"))&&(localStorage.removeItem("si-engine-save"),window.location.reload())},className:"bg-red-900/50 hover:bg-red-600 border border-red-700 text-red-200 px-4 py-2 rounded-lg text-xs font-bold flex items-center gap-2",children:[(0,t.jsx)(c,{size:14})," ",o("si.equipment.reset")]}),e.length>0&&(0,t.jsxs)("button",{onClick:()=>{let t=new Blob(["\uFEFF"+["分類 (Category),角色 (Role),品牌 (Brand),系列 (Series),型號 (Model),數量 (Qty),單價 (Unit Price),小計 (Subtotal)",...e.map(e=>[e.category,B[e.systemRole]||e.systemRole,e.brand,e.series||"",e.model,e.qty,e.unitPrice,e.qty*e.unitPrice]).map(e=>e.map(e=>`"${e}"`).join(","))].join("\n")],{type:"text/csv;charset=utf-8;"}),s=URL.createObjectURL(t),l=document.createElement("a");l.setAttribute("href",s),l.setAttribute("download",`ADG-BOM-${new Date().toISOString().split("T")[0]}.csv`),l.style.visibility="hidden",document.body.appendChild(l),l.click(),document.body.removeChild(l)},className:"bg-indigo-900/50 hover:bg-indigo-600 border border-indigo-700 text-indigo-200 px-4 py-2 rounded-lg text-xs font-bold flex items-center gap-2 transition-colors",children:[(0,t.jsx)(w,{size:14})," 導出清單 (Export CSV)"]})]}),(0,t.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8",children:[(0,t.jsxs)("div",{className:"bg-slate-900/80 p-6 rounded-xl border border-slate-700",children:[(0,t.jsx)("h3",{className:"text-sm font-bold text-slate-400 uppercase mb-4",children:o("si.equipment.title")}),(0,t.jsxs)("div",{className:"flex flex-col gap-4",children:[(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,t.jsx)("select",{className:"bg-slate-800 border border-slate-600 rounded p-2 text-white",value:n.id,onChange:e=>d(W.find(t=>t.id===e.target.value)||W[0]),children:W.map(e=>(0,t.jsx)("option",{value:e.id,children:o(`si.cat.${e.id}`)},e.id))}),(0,t.jsx)("select",{className:"bg-slate-800 border border-slate-600 rounded p-2 text-white",value:x,onChange:e=>h(e.target.value),children:["Main PA","Subwoofer","Stage Monitor","Front Fill","Delay","BGM"].map(e=>(0,t.jsx)("option",{value:e,children:o(`si.role.${{"Main PA":"mainpa",Subwoofer:"subwoofer","Stage Monitor":"monitor","Front Fill":"frontfill",Delay:"delay",BGM:"bgm"}[e]}`)},e))})]}),(0,t.jsxs)("div",{className:"flex gap-2",children:[(0,t.jsxs)("select",{className:"flex-1 bg-slate-800 border border-slate-600 rounded p-2 text-white",value:p,onChange:e=>b(e.target.value),children:[(0,t.jsx)("option",{value:"",children:o("si.equipment.brand")}),C.map(e=>(0,t.jsx)("option",{value:e,children:e},e))]}),(0,t.jsxs)("select",{className:"flex-1 bg-slate-800 border border-slate-600 rounded p-2 text-white",value:g,onChange:e=>f(e.target.value),children:[(0,t.jsx)("option",{value:"",children:o("si.equipment.select")}),P.map(e=>(0,t.jsx)("option",{value:e,children:e},e))]})]}),(0,t.jsxs)("select",{className:"w-full bg-slate-800 border border-slate-600 rounded p-2 text-white",value:j?.model||"",onChange:e=>{let t=I.find(t=>t.model===e.target.value);v(t),M(t?t.price:0)},children:[(0,t.jsx)("option",{value:"",children:o("si.equipment.selectModel")}),I.map(e=>(0,t.jsx)("option",{value:e.model,children:e.model},e.model))]}),(0,t.jsxs)("div",{className:"flex gap-4 items-center",children:[(0,t.jsxs)("div",{className:"flex-[1]",children:[(0,t.jsx)("label",{className:"text-xs text-slate-500 mb-1 block",children:o("si.equipment.qty")}),(0,t.jsx)("input",{type:"number",className:"w-full bg-slate-800 border border-slate-600 rounded p-2 text-white",value:y,onChange:e=>N(e.target.value)})]}),(0,t.jsxs)("div",{className:"flex-[1.5]",children:[(0,t.jsx)("label",{className:"text-xs text-slate-500 mb-1 block",children:o("si.equipment.price")}),(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)("span",{className:"absolute left-2 top-1/2 -translate-y-1/2 text-slate-500",children:"$"}),(0,t.jsx)("input",{type:"number",className:"w-full bg-slate-800 border border-slate-600 rounded p-2 pl-6 text-white font-mono",value:k,onChange:e=>M(e.target.value)})]})]}),(0,t.jsx)("button",{onClick:()=>{j&&s([...e,{id:Date.now(),category:n.name,systemRole:x,...j,qty:parseInt(y),unitPrice:parseFloat(k)||0}])},disabled:!j,className:`flex-[2] mt-5 font-bold py-2 rounded shadow-lg transition-all active:scale-95 ${!j?"bg-slate-700 text-slate-500 cursor-not-allowed":"bg-indigo-600 hover:bg-indigo-500 text-white"}`,children:o("si.equipment.addToList")})]})]})]}),(0,t.jsxs)("div",{className:"bg-slate-900/80 p-6 rounded-xl border border-slate-700",children:[(0,t.jsx)("h3",{className:"text-sm font-bold text-slate-400 uppercase mb-4",children:o("si.equipment.bom")}),(0,t.jsx)("div",{className:"space-y-2 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar",children:0===e.length?(0,t.jsx)("div",{className:"text-center py-10 text-slate-600 italic",children:o("si.equipment.none")}):e.map((l,a)=>(0,t.jsxs)("div",{className:"flex justify-between items-center p-3 bg-slate-800/50 border border-slate-700 rounded-lg group hover:border-orange-500/50 transition-colors",children:[(0,t.jsxs)("div",{className:"flex gap-3 items-center",children:[(0,t.jsx)("div",{className:"w-8 h-8 rounded bg-slate-700 flex items-center justify-center text-orange-500 font-bold text-xs",children:l.qty}),(0,t.jsxs)("div",{children:[(0,t.jsx)("div",{className:"font-bold text-sm text-white",children:l.model}),(0,t.jsxs)("div",{className:"text-[10px] text-slate-500 font-medium",children:[(0,t.jsx)("span",{className:"text-orange-500/80",children:B[l.systemRole]||l.systemRole})," | ",l.brand," | ",l.category]})]})]}),(0,t.jsx)("button",{onClick:()=>{let t;return t=l.id,s(e.filter(e=>e.id!==t))},className:"p-2 text-slate-500 hover:text-red-400 hover:bg-red-900/20 rounded opacity-0 group-hover:opacity-100 transition-opacity",children:(0,t.jsx)(c,{size:16})})]},a))})]})]}),e.length>0&&(0,t.jsx)("div",{className:"bg-slate-900/90 backdrop-blur-xl p-6 rounded-2xl border border-indigo-500/30 shadow-[0_0_20px_rgba(79,70,229,0.1)] animate-in zoom-in-95",children:(0,t.jsxs)("div",{className:"flex flex-col md:flex-row justify-between items-center gap-6",children:[(0,t.jsxs)("div",{className:"flex items-center gap-4",children:[(0,t.jsx)("div",{className:"w-12 h-12 rounded-xl bg-indigo-600/20 flex items-center justify-center border border-indigo-500/50",children:(0,t.jsx)(m.Zap,{className:"text-indigo-400",size:24})}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h4",{className:"text-xs font-bold text-indigo-400 uppercase tracking-[0.2em] mb-1",children:"電力配置摘要 (Power Requirements)"}),(0,t.jsx)("p",{className:"text-sm text-slate-400",children:"根據目前設備清單自動計算之電力需求預算"})]})]}),(0,t.jsxs)("div",{className:"grid grid-cols-3 gap-8",children:[(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("div",{className:"text-[10px] text-slate-500 uppercase font-black tracking-widest mb-1",children:"總功率 (Total)"}),(0,t.jsxs)("div",{className:"text-3xl font-black text-white font-mono tracking-tighter",children:[e.reduce((e,t)=>e+(t.power||0)*t.qty,0).toLocaleString()," ",(0,t.jsx)("span",{className:"text-xs text-slate-500",children:"W"})]})]}),(0,t.jsxs)("div",{className:"text-center border-l border-slate-800 pl-8",children:[(0,t.jsx)("div",{className:"text-[10px] text-slate-500 uppercase font-black tracking-widest mb-1",children:"110V 電流 (Amp)"}),(0,t.jsxs)("div",{className:"text-3xl font-black text-orange-500 font-mono tracking-tighter",children:[(e.reduce((e,t)=>e+(t.power||0)*t.qty,0)/110).toFixed(1)," ",(0,t.jsx)("span",{className:"text-xs text-slate-500",children:"A"})]})]}),(0,t.jsxs)("div",{className:"text-center border-l border-slate-800 pl-8",children:[(0,t.jsx)("div",{className:"text-[10px] text-slate-500 uppercase font-black tracking-widest mb-1",children:"220V 電流 (Amp)"}),(0,t.jsxs)("div",{className:"text-3xl font-black text-blue-500 font-mono tracking-tighter",children:[(e.reduce((e,t)=>e+(t.power||0)*t.qty,0)/220).toFixed(1)," ",(0,t.jsx)("span",{className:"text-xs text-slate-500",children:"A"})]})]})]})]})}),(0,t.jsx)("div",{className:"fixed bottom-8 right-8 z-50",children:(0,t.jsxs)("button",{disabled:0===e.length,onClick:()=>i(3),className:`pl-6 pr-4 py-4 rounded-full font-bold shadow-2xl flex gap-2 transition-all ${0===e.length?"bg-slate-700 opacity-50 cursor-not-allowed":"bg-orange-600 hover:bg-orange-500 text-white"}`,children:[o("si.equipment.next")," ",(0,t.jsx)(u.ChevronRight,{})]})})]})}function V({bom:e,projectInfo:s,setProjectInfo:a,canvasObjects:r,setCanvasObjects:i,setPhase:d,t:m}){let[p,b]=(0,l.useState)({active:!1,queue:[],roleIndex:0,step:0,points:{}}),[g,f]=(0,l.useState)("select"),[v,N]=(0,l.useState)([]),[w,k]=(0,l.useState)([]),[M,S]=(0,l.useState)(!1),[D,T]=(0,l.useState)(!0),[A,F]=(0,l.useState)({k:1,x:0,y:0}),[L,E]=(0,l.useState)(null),[W,_]=(0,l.useState)(null),[B,O]=(0,l.useState)(null),[H,G]=(0,l.useState)(null),[U,V]=(0,l.useState)(90),[Y,Z]=(0,l.useState)(!1),[X,Q]=(0,l.useState)({x:0,y:0}),[K,J]=(0,l.useState)({x:0,y:0}),[ee,et]=(0,l.useState)(!1),[es,el]=(0,l.useState)("low"),[ea,er]=(0,l.useState)(1e3),[ei,eo]=(0,l.useState)(null),[en,ed]=(0,l.useState)("direct"),[ec,ex]=(0,l.useState)(90),[eh,em]=(0,l.useState)(!1),[ep,eb]=(0,l.useState)(110),[eu,eg]=(0,l.useState)({x:20,y:500}),[ef,ej]=(0,l.useState)(!1),ev=(0,l.useRef)({x:0,y:0}),[ey,eN]=(0,l.useState)(null),ew=(0,l.useRef)(null),ek=(0,l.useRef)(null);(0,l.useEffect)(()=>{if(ew.current){let{clientWidth:e,clientHeight:t}=ew.current,l=Math.min(.9*e/(s.roomWidth||20),.9*t/s.roomDepth),a=(e-s.roomWidth*l)/2,r=(t-s.roomDepth*l)/2;F({k:l,x:a,y:r})}},[s.roomWidth,s.roomDepth]);let eM=()=>{N(e=>[...e,r]),k([])},eS=e.filter(e=>e.category.includes("音響")||e.category.includes("Speaker")),[eC,eP]=(0,l.useState)(null);(0,l.useEffect)(()=>{if(s.bgImage){let e=new Image;e.src=s.bgImage,e.onload=()=>eP(e)}else eP(null)},[s.bgImage]),(0,l.useEffect)(()=>{let e=e=>{("Delete"===e.key||"Backspace"===e.key)&&L&&(i(e=>e.filter(e=>e.id!==L)),E(null)),"Escape"===e.key&&(b(e=>({...e,active:!1,roleIndex:0,step:0})),f("select"))};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[L]),(0,l.useEffect)(()=>{let e=()=>ej(!1),t=e=>{ef&&eg({x:e.clientX-ev.current.x,y:e.clientY-ev.current.y})};return window.addEventListener("mouseup",e),window.addEventListener("mousemove",t),()=>{window.removeEventListener("mouseup",e),window.removeEventListener("mousemove",t)}},[ef]),(0,l.useEffect)(()=>{if(!M)return void _(null);let e=setTimeout(async()=>{let e="high"===es?200:100,t=Math.round(e*(s.roomDepth/s.roomWidth));new Float32Array(e*t*2);let l=2*Math.PI*ea/343,a=r.filter(e=>e.model).map(e=>{let t=eS.find(t=>t.model===e.model),s=Math.pow(10,(t?.maxSpl||120)/20),l=t?.coverage||90;return{x:e.x,y:e.y,rot:(e.rotation||0)*Math.PI/180+Math.PI/2,ampRef:s,cov:l}});if(0===a.length)return;let i=new Float32Array(e*t);for(let r=0;r<t;r++)for(let o=0;o<e;o++){let n=o/e*s.roomWidth,d=r/t*s.roomDepth,c=0,x=0,h=0;for(let e of a){let t=n-e.x,s=d-e.y,a=Math.sqrt(t*t+s*s);if(a<.1)continue;let r=Math.abs(Math.atan2(s,t)-e.rot);for(;r>Math.PI;)r-=2*Math.PI;for(;r<-Math.PI;)r+=2*Math.PI;r=Math.abs(r);let i=0;ea>200&&e.cov<350&&((i=Math.log(.5)/Math.log(Math.cos(e.cov/2*Math.PI/180)))<0||isNaN(i))&&(i=0);let o=Math.pow(Math.cos(Math.min(r,Math.PI/2)),i),m=e.ampRef/a*o;if("direct"===en)h+=m*m;else{let e=l*a;c+=m*Math.cos(e),x+=m*Math.sin(e)}}let m=-1/0;m="direct"===en?20*Math.log10(Math.sqrt(h)+1e-6):20*Math.log10(Math.sqrt(c*c+x*x)+1e-6),"snr"===en&&(m-=ec),i[r*e+o]=m}let o=-1/0;for(let e of i)e>o&&(o=e);let n=new OffscreenCanvas(e,t),d=n.getContext("2d"),c=d.createImageData(e,t),x="snr"===en?20:Math.ceil(o);Math.abs(x-ep)>1&&eb(x);for(let s=0;s<e*t;s++){let e=(i[s]-(x-40))/40;e<0&&(e=0),e>1&&(e=1);let t=(1-e)*240,l=(1-Math.abs(0))*1,a=l*(1-Math.abs(t/60%2-1)),r=.5-l/2,o=0,n=0,d=0;0<=t&&t<60?(o=l,n=a,d=0):60<=t&&t<120?(o=a,n=l,d=0):120<=t&&t<180?(o=0,n=l,d=a):180<=t&&t<240?(o=0,n=a,d=l):240<=t&&t<300?(o=a,n=0,d=l):(o=l,n=0,d=a),c.data[4*s]=(o+r)*255,c.data[4*s+1]=(n+r)*255,c.data[4*s+2]=(d+r)*255,c.data[4*s+3]=200*e}d.putImageData(c,0,0),_(await n.transferToImageBitmap())},50);return()=>clearTimeout(e)},[M,ea,es,r,s,en,ec,ep]),(0,l.useEffect)(()=>{let e=ek.current;if(!e||!e.getContext("2d"))return;let t=e.getContext("2d");ew.current&&(e.width=ew.current.clientWidth,e.height=ew.current.clientHeight),t.fillStyle="#0f172a",t.fillRect(0,0,e.width,e.height),t.save(),t.translate(A.x,A.y),t.scale(A.k,A.k);let l=s.roomWidth||20,a=s.roomDepth||15;if(eC?t.drawImage(eC,0,0,l,a):(t.fillStyle="#1e293b",t.fillRect(0,0,l,a)),M&&W&&(t.globalAlpha=.8,t.drawImage(W,0,0,l,a),t.globalAlpha=1),D){t.lineWidth=.05,t.strokeStyle="rgba(255,255,255,0.1)",t.beginPath();for(let e=0;e<=l;e++)t.moveTo(e,0),t.lineTo(e,a);for(let e=0;e<=a;e++)t.moveTo(0,e),t.lineTo(l,e);t.stroke()}if(r.forEach(e=>{let s=L===e.id;t.save(),t.translate(e.x,e.y),t.rotate((e.rotation||0)*Math.PI/180);let l=e.model.toLowerCase(),a=l.includes("sub")||l.includes("18s");if(e.role,!M&&!a){let l=(e.coverage||90)/2*Math.PI/180;t.setLineDash([.5,.5,.1,.5]),t.lineWidth=.03,t.strokeStyle=s?"#f97316":"rgba(249, 115, 22, 0.5)",t.beginPath(),t.moveTo(0,0),t.lineTo(0,30),t.stroke(),t.setLineDash([1,1]),t.lineWidth=.04,t.strokeStyle="#f97316",t.beginPath(),t.moveTo(0,0),t.lineTo(20*Math.sin(l),20*Math.cos(l)),t.stroke(),t.beginPath(),t.moveTo(0,0),t.lineTo(20*Math.sin(-l),20*Math.cos(-l)),t.stroke(),t.beginPath(),t.arc(0,0,10,-l+Math.PI/2,l+Math.PI/2),t.strokeStyle="rgba(249, 115, 22, 0.2)",t.stroke(),t.setLineDash([])}let r="#f97316",i=e.role||"Main PA";if(i.toLowerCase(),"Stage Monitor"===i?r="#22c55e":"Subwoofer"===i?r="#a855f7":"Delay"===i?r="#06b6d4":"Front Fill"===i&&(r="#eab308"),t.fillStyle=s?"#ffffff":r,t.strokeStyle="#000",t.lineWidth=.02,"Subwoofer"===i?(t.fillRect(-.4,-.4,.8,.8),t.beginPath(),t.moveTo(-.4,-.4),t.lineTo(.4,.4),t.stroke(),t.beginPath(),t.moveTo(.4,-.4),t.lineTo(-.4,.4),t.stroke()):"Stage Monitor"===i?(t.beginPath(),t.moveTo(-.35,-.2),t.lineTo(.35,-.2),t.lineTo(0,.4),t.closePath(),t.fill(),t.beginPath(),t.moveTo(-.2,0),t.lineTo(.2,0),t.stroke()):"Delay"===i?(t.beginPath(),t.moveTo(-.25,-.25),t.lineTo(.25,-.25),t.lineTo(.15,.25),t.lineTo(-.15,.25),t.closePath(),t.fill()):"Front Fill"===i?(t.fillRect(-.3,-.15,.6,.3),t.strokeRect(-.3,-.15,.6,.3)):(t.beginPath(),t.moveTo(-.3,-.4),t.lineTo(.3,-.4),t.lineTo(.4,.3),t.lineTo(-.4,.3),t.closePath(),t.fill(),t.fillStyle="#111",t.beginPath(),t.arc(0,.1,.15,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(0,-.15,.1,0,2*Math.PI),t.fill()),"Subwoofer"!==i){t.save(),t.rotate(-(e.rotation||0)*Math.PI/180),t.font="bold 0.25px sans-serif",t.fillStyle="#fff";let s=Math.round(e.rotation),l=e.h||0;t.fillStyle=r,t.fillText(`${i}`,.6,-.4),t.fillStyle="#ea580c",t.fillText(`Pan: ${s}\xb0`,.6,-.1),t.fillStyle="#94a3b8",t.fillText(`H: ${l}cm`,.6,.2),t.restore()}t.restore(),s&&(t.strokeStyle="#fff",t.lineWidth=2/A.k,t.beginPath(),t.arc(e.x,e.y,.6,0,2*Math.PI),t.stroke())}),p.active){let e=requestAnimationFrame(()=>{});return()=>cancelAnimationFrame(e)}},[r,s,A,D,L,p,eC,W]);let eI=e=>{let t=ew.current.getBoundingClientRect(),s={x:t.width/2,y:t.height/2},l=Math.min(Math.max(A.k*(e>0?1.2:.8),5),200),a=(s.x-A.x)/A.k,r=(s.y-A.y)/A.k;F({k:l,x:s.x-a*l,y:s.y-r*l})},ez=()=>{Z(!1),et(!1)};return(0,t.jsxs)("div",{className:"flex flex-col lg:flex-row h-[calc(100vh-140px)] gap-4 animate-in fade-in",children:[p.active&&(0,t.jsxs)("div",{className:"absolute top-20 left-1/2 -translate-x-1/2 px-6 py-3 bg-indigo-600 rounded-full shadow-lg z-10 flex items-center gap-4 text-white animate-in slide-in-from-top-4 fade-in min-w-[400px]",children:[(0,t.jsx)(C,{className:"w-5 h-5 animate-pulse"}),(0,t.jsxs)("div",{className:"flex flex-col",children:[(0,t.jsxs)("span",{className:"font-bold text-sm uppercase text-indigo-200",children:["正在佈署: ",p.queue[p.roleIndex]?.label," (",p.roleIndex+1,"/",p.queue.length,")"]}),(0,t.jsxs)("span",{className:"font-bold text-base",children:[1===p.step&&m("si.wizard.step1"),2===p.step&&m("si.wizard.step2"),3===p.step&&m("si.wizard.step3")]})]}),(0,t.jsx)("button",{onClick:()=>{b(e=>({...e,active:!1})),f("select")},className:"p-1 hover:bg-white/20 rounded-full ml-auto",children:(0,t.jsx)(P.X,{className:"w-4 h-4"})})]}),(0,t.jsxs)("div",{className:"w-full lg:w-64 bg-slate-900/80 backdrop-blur p-4 rounded-xl border border-slate-700 shadow-xl overflow-y-auto",children:[(0,t.jsx)("h3",{className:"text-xs font-bold text-slate-500 uppercase mb-3",children:m("si.deploy.library")}),(0,t.jsxs)("button",{onClick:()=>{let e=[],t=(t,s,l)=>{if(0===l.length)return;let a=l[0],r=l.reduce((e,t)=>e+t.qty,0),i=1;for(;r>0;){let l=r>=2?2:1,o=2===l?"lr":"point";e.push({id:`task_${t.toLowerCase().replace(/\s/g,"")}_${i}`,role:t,label:2===l?`${s} (Group ${i}) - L/R Pair`:`${s} (Group ${i}) - Single Point`,mode:o,model:a.model,coverage:a.coverage||90,count:l}),r-=l,i++}};t("Main PA","主擴音系統 (Main PA)",eS.filter(e=>"Main PA"===e.systemRole));let s=eS.filter(e=>"Subwoofer"===e.systemRole);if(s.length>0){let t=s.reduce((e,t)=>e+t.qty,0);e.push({id:"task_sub",role:"Subwoofer",label:`超低音 (Subwoofer) - Line Array (${t} units)`,mode:"line",model:s[0].model,coverage:360,count:t})}let l=eS.filter(e=>"Front Fill"===e.systemRole);if(l.length>0){let t=l.reduce((e,t)=>e+t.qty,0);e.push({id:"task_fill",role:"Front Fill",label:`前區補聲 (Front Fill) - Distributed (${t} units)`,mode:"line",model:l[0].model,coverage:l[0].coverage||90,count:t})}let a=eS.filter(e=>"Stage Monitor"===e.systemRole);if(a.length>0){let t=a.reduce((e,t)=>e+t.qty,0);e.push({id:"task_mon",role:"Stage Monitor",label:`舞台監聽 (Stage Monitor) - Line (${t} units)`,mode:"line",model:a[0].model,coverage:a[0].coverage||60,count:t})}(t("Delay","延遲補聲 (Delay)",eS.filter(e=>"Delay"===e.systemRole)),t("BGM","背景音樂 (BGM)",eS.filter(e=>"BGM"===e.systemRole)),0===e.length)?alert(m("si.alert.nodeploy")):(b({active:!0,queue:e,roleIndex:0,step:1,points:{p1:null,p2:null,t:null}}),f("ai_point"))},className:"w-full bg-indigo-600 hover:bg-indigo-500 text-white p-3 rounded-lg font-bold mb-4 flex items-center justify-center gap-2 shadow-lg shadow-indigo-500/20 transition-all hover:scale-105",children:[(0,t.jsx)(y,{size:18}),m("si.deploy.wizard")]}),(0,t.jsx)("div",{className:"h-[1px] bg-slate-700 mb-4"}),eS.map((e,s)=>(0,t.jsxs)("div",{draggable:!0,onDragStart:t=>{G(e.model),V(e.coverage||90)},className:"p-3 mb-2 bg-black/50 rounded border border-slate-700 hover:border-orange-500 cursor-grab",children:[(0,t.jsx)("div",{className:"font-bold text-sm text-white",children:e.model}),(0,t.jsx)("div",{className:"text-[10px] text-slate-400",children:m("si.deploy.drag")})]},s))]}),(0,t.jsxs)("div",{className:"flex-1 relative bg-slate-950 rounded-xl border border-slate-800 overflow-hidden",ref:ew,onDragOver:e=>e.preventDefault(),onDrop:e=>{e.preventDefault();let t=ek.current.getBoundingClientRect();if(H){eM();let s=(e.clientX-t.left-A.x)/A.k,l=(e.clientY-t.top-A.y)/A.k;i(e=>[...e,{id:Date.now().toString(),model:H,coverage:U,rotation:0,x:Math.round(2*s)/2,y:Math.round(2*l)/2}]),G(null)}},children:[(0,t.jsxs)("div",{className:"absolute top-4 left-4 flex gap-2 z-10",children:[(0,t.jsxs)("div",{className:"bg-slate-900/90 rounded border border-white/10 p-1 flex gap-1",children:[(0,t.jsx)("button",{onClick:()=>f("select"),className:`p-2 rounded ${"select"===g?"bg-orange-600":""}`,title:"選取 / 移動",children:(0,t.jsx)(y,{size:18})}),(0,t.jsx)("button",{onClick:()=>f("hand"),className:`p-2 rounded ${"hand"===g?"bg-orange-600":""}`,title:"平移畫面",children:(0,t.jsx)(x,{size:18})})]}),(0,t.jsxs)("div",{className:"bg-slate-900/90 rounded border border-white/10 p-1 flex gap-1",children:[(0,t.jsx)("button",{onClick:()=>{if(0===v.length)return;let e=v[v.length-1];k(e=>[r,...e]),i(e),N(e=>e.slice(0,-1))},disabled:0===v.length,className:"p-2 text-slate-300 disabled:opacity-30 hover:bg-white/10 rounded",title:"復原 (Undo)",children:(0,t.jsx)(I,{size:18})}),(0,t.jsx)("button",{onClick:()=>{if(0===w.length)return;let e=w[0];N(e=>[...e,r]),i(e),k(e=>e.slice(1))},disabled:0===w.length,className:"p-2 text-slate-300 disabled:opacity-30 hover:bg-white/10 rounded",title:"重做 (Redo)",children:(0,t.jsx)(z,{size:18})}),(0,t.jsx)("div",{className:"w-[1px] bg-slate-700 mx-1"}),(0,t.jsx)("button",{onClick:()=>{confirm(m("si.confirm.clear"))&&(eM(),i([]))},className:"p-2 text-red-400 hover:bg-red-900/30 rounded",title:"全部清除",children:(0,t.jsx)(c,{size:18})})]}),(0,t.jsxs)("div",{className:"bg-slate-900/90 rounded border border-white/10 p-1 flex gap-1",children:[(0,t.jsx)("button",{onClick:()=>T(!D),className:"p-2 text-slate-400",title:"顯示格線",children:(0,t.jsx)(j.Grid,{size:18})}),(0,t.jsx)("button",{onClick:()=>S(!M),className:`p-2 ${M?"bg-indigo-600 text-white shadow-[0_0_15px_rgba(79,70,229,0.5)]":"text-slate-400 hover:text-white"}`,title:"聲學模擬 (Acoustic Simulation)",children:(0,t.jsx)(R,{size:18})}),(0,t.jsx)("button",{onClick:()=>{let e=document.createElement("a");e.download="layout.png",e.href=ek.current.toDataURL(),e.click()},className:"p-2 text-slate-400 hover:text-white",title:"匯出圖片",children:(0,t.jsx)(o.Download,{size:18})})]})]}),M&&(0,t.jsxs)("div",{className:`absolute bg-slate-900/95 backdrop-blur border border-indigo-500/50 rounded-xl shadow-2xl flex flex-col gap-3 animate-in slide-in-from-bottom-4 zoom-in-95 z-40 transition-all duration-300 ${eh?"p-2 w-auto":"p-4 min-w-[300px]"}`,style:{left:eu.x,top:eu.y},children:[(0,t.jsxs)("div",{className:`flex justify-between items-center ${eh?"":"border-b border-white/10 pb-2"} cursor-move`,onMouseDown:e=>{ej(!0),ev.current={x:e.clientX-eu.x,y:e.clientY-eu.y}},children:[!eh&&(0,t.jsxs)("h3",{className:"text-xs font-bold text-indigo-300 uppercase flex items-center gap-2",children:[(0,t.jsx)(R,{size:14})," 聲學模擬 (Physics)"]}),eh&&(0,t.jsx)(R,{className:"text-indigo-400 animate-pulse",size:20}),(0,t.jsxs)("div",{className:"flex gap-2",children:[(0,t.jsx)("button",{onClick:()=>em(!eh),className:"text-slate-400 hover:text-white p-1 rounded hover:bg-white/10",title:eh?"展開":"縮小",children:eh?(0,t.jsx)(h,{size:14}):(0,t.jsx)($,{size:14})}),!eh&&(0,t.jsxs)("button",{onClick:()=>el("low"===es?"high":"low"),className:`text-[10px] px-2 py-1 rounded border ${"high"===es?"bg-indigo-600 border-transparent":"border-slate-600 text-slate-400"}`,children:["HQ: ","high"===es?"ON":"OFF"]})]})]}),!eh&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,t.jsx)("div",{className:"flex justify-between text-xs text-slate-400",children:(0,t.jsx)("span",{children:"顯示模式 (View)"})}),(0,t.jsxs)("div",{className:"flex bg-slate-800 rounded p-1 gap-1",children:[(0,t.jsx)("button",{onClick:()=>ed("direct"),className:`flex-1 text-[10px] py-1 rounded ${"direct"===en?"bg-indigo-600 text-white":"text-slate-400 hover:text-white"}`,children:"Direct (直達)"}),(0,t.jsx)("button",{onClick:()=>ed("total"),className:`flex-1 text-[10px] py-1 rounded ${"total"===en?"bg-indigo-600 text-white":"text-slate-400 hover:text-white"}`,children:"Total (總和)"}),(0,t.jsx)("button",{onClick:()=>ed("snr"),className:`flex-1 text-[10px] py-1 rounded ${"snr"===en?"bg-indigo-600 text-white":"text-slate-400 hover:text-white"}`,children:"S/N (信噪)"})]})]}),"snr"===en&&(0,t.jsxs)("div",{className:"flex flex-col gap-1 animate-in slide-in-from-top-2",children:[(0,t.jsxs)("div",{className:"flex justify-between text-xs text-slate-400",children:[(0,t.jsx)("span",{children:"背景噪音 (Noise Floor)"}),(0,t.jsxs)("span",{className:"text-white",children:[ec," dB"]})]}),(0,t.jsx)("input",{type:"range",min:"30",max:"110",step:"1",value:ec,onChange:e=>ex(Number(e.target.value)),className:"w-full h-1 bg-slate-700 rounded-lg accent-red-500"})]}),(0,t.jsxs)("div",{className:"pt-2 border-t border-white/10 flex flex-col gap-2",children:[(0,t.jsxs)("button",{onClick:()=>{if(!ek.current)return;let e=ek.current.toDataURL("image/png"),t=s.simSnapshots||[];if(t.length>=5)return void alert("最多只能儲存 5 張模擬快照 (Max 5 Snapshots)");let l={id:Date.now(),dataUrl:e,freq:ea,mode:en};a({...s,simSnapshots:[...t,l]}),alert("已擷取當前模擬圖並保存至報表")},className:"flex-1 bg-slate-800 hover:bg-slate-700 text-slate-300 hover:text-white py-2 rounded text-xs font-bold flex items-center justify-center gap-2 border border-slate-600 active:scale-95 transition-all",children:[(0,t.jsx)(q,{size:14}),m("si.sim.snapshot")||"截圖 (Snapshot)",(0,t.jsxs)("span",{className:"bg-black/50 px-1.5 rounded-full text-[10px]",children:[(s.simSnapshots||[]).length,"/5"]})]}),(s.simSnapshots||[]).length>0&&(0,t.jsx)("button",{onClick:()=>{confirm(m("si.confirm.clear_snaps")||"清除所有截圖?")&&a({...s,simSnapshots:[]})},className:"px-3 bg-red-900/30 hover:bg-red-800/50 text-red-400 border border-red-900/50 rounded flex items-center justify-center",children:(0,t.jsx)(c,{size:14})})]}),(0,t.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,t.jsxs)("div",{className:"flex justify-between text-xs text-slate-400",children:[(0,t.jsx)("span",{children:"頻率 (Freq)"}),(0,t.jsxs)("span",{className:"text-white",children:[ea," Hz"]})]}),(0,t.jsx)("input",{type:"range",min:"63",max:"4000",step:"10",value:ea,onChange:e=>er(Number(e.target.value)),className:"w-full h-1 bg-slate-700 rounded-lg accent-indigo-500"})]}),ei&&(0,t.jsxs)("div",{className:"bg-black/50 p-2 rounded flex justify-between items-center",children:[(0,t.jsxs)("span",{className:"text-xs text-slate-400",children:["Probe ","snr"===en?"S/N":"SPL",":"]}),(0,t.jsxs)("span",{className:`text-sm font-bold ${"snr"===en&&ei.spl<0?"text-red-500":"text-orange-400"}`,children:[ei.spl.toFixed(1)," dB"]})]}),(0,t.jsxs)("div",{className:"flex bg-slate-800 rounded p-2 gap-2 items-center",children:[(0,t.jsx)("div",{className:"h-24 w-4 rounded bg-gradient-to-t from-blue-600 via-green-500 to-red-600 border border-slate-600"}),(0,t.jsxs)("div",{className:"flex flex-col justify-between h-24 text-[10px] text-slate-400 font-mono",children:[(0,t.jsxs)("span",{children:["snr"===en?"+20":ep," dB"]}),(0,t.jsxs)("span",{children:["snr"===en?"0":ep-20," dB"]}),(0,t.jsxs)("span",{children:["snr"===en?"-20":ep-40," dB"]})]})]})]})]}),(0,t.jsx)("div",{className:"absolute bottom-6 right-20 pointer-events-none flex flex-col items-center",children:(0,t.jsx)("div",{className:"border-b-2 border-white/50 text-center text-[10px] text-white/50 pb-1 transition-all duration-300",style:{width:Math.max(20,5*A.k)},children:"5 Meters"})}),(0,t.jsxs)("div",{className:"absolute bottom-6 right-6 flex flex-col gap-2 z-10",children:[" ",(0,t.jsx)("button",{onClick:()=>eI(1),className:"bg-slate-800 p-3 rounded-full",children:(0,t.jsx)(n.Plus,{size:20})}),(0,t.jsx)("button",{onClick:()=>eI(-1),className:"bg-slate-800 p-3 rounded-full",children:(0,t.jsx)("div",{className:"w-5 h-[2px] bg-white"})})]}),ey&&(0,t.jsxs)("div",{className:"absolute bg-slate-800 border border-slate-600 rounded-lg py-1 z-50 text-xs text-white shadow-xl min-w-[140px]",style:{left:ey.x,top:ey.y},onMouseLeave:()=>eN(null),children:[(0,t.jsx)("button",{className:"block w-full text-left px-4 py-2 hover:bg-orange-600",onClick:()=>{eM(),i(e=>e.map(e=>e.id===ey.id?{...e,rotation:(e.rotation||0)+45}:e)),eN(null)},children:"旋轉 +45°"}),(0,t.jsx)("button",{className:"block w-full text-left px-4 py-2 hover:bg-orange-600",onClick:()=>{eM();let e=r.find(e=>e.id===ey.id);e&&i(t=>t.map(t=>t.systemRole===e.systemRole?{...t,rotation:(t.rotation||0)+45}:t)),eN(null)},children:"批次旋轉 (同角色)"}),(0,t.jsx)("div",{className:"h-[1px] bg-slate-700 my-1"}),(0,t.jsx)("button",{className:"block w-full text-left px-4 py-2 hover:bg-orange-600",onClick:()=>{eM();let e=r.find(e=>e.id===ey.id);e&&i([...r,{...e,id:Date.now()+"_copy",x:e.x+1,y:e.y+1}]),eN(null)},children:"複製"}),(0,t.jsx)("button",{className:"block w-full text-left px-4 py-2 hover:bg-red-600 text-red-200",onClick:()=>{eM(),i(e=>e.filter(e=>e.id!==ey.id)),eN(null)},children:"刪除"})]}),(0,t.jsx)("canvas",{ref:ek,onMouseDown:e=>{if(!ek.current)return;let t=ek.current.getBoundingClientRect(),s=e.clientX-t.left,l=e.clientY-t.top,a=(s-A.x)/A.k,o=(l-A.y)/A.k;if("ai_point"===g&&p.active)return void((e,t)=>{let{queue:s,roleIndex:l,step:a,points:r}=p,o=s[l];if(1===a){let s={...r,p1:{x:e,y:t}};"point"===o.mode?b(e=>({...e,step:3,points:s})):b(e=>({...e,step:2,points:s}))}else if(2===a){let s={...r,p2:{x:e,y:t}};b(e=>({...e,step:3,points:s}))}else 3===a&&(((e,t)=>{eM();let{p1:s,p2:l,t:a}=t,r=[];if("lr"===e.mode){let t=180*Math.atan2(a.y-s.y,a.x-s.x)/Math.PI-90,i=180*Math.atan2(a.y-l.y,a.x-l.x)/Math.PI-90;r.push({id:Date.now()+"_L",role:e.role,model:e.model,coverage:e.coverage,x:s.x,y:s.y,rotation:t,h:400}),r.push({id:Date.now()+"_R",role:e.role,model:e.model,coverage:e.coverage,x:l.x,y:l.y,rotation:i,h:400})}else if("line"===e.mode){let t=l.x-s.x,i=l.y-s.y,o=(s.x+l.x)/2,n=(s.y+l.y)/2,d=180*Math.atan2(a.y-n,a.x-o)/Math.PI-90,c=e.count;for(let l=0;l<c;l++){let a=c>1?l/(c-1):.5,o=s.x+t*a,n=s.y+i*a;r.push({id:Date.now()+`_${e.role}_${l}`,role:e.role,model:e.model,coverage:e.coverage,x:o,y:n,rotation:d,h:100*("Front Fill"===e.role)})}}else if("point"===e.mode){let t=180*Math.atan2(a.y-s.y,a.x-s.x)/Math.PI-90,l=e.count,i=(t+90)*Math.PI/180,o=Math.cos(i),n=Math.sin(i);for(let a=0;a<l;a++){let i=1===l?0:0===a?-.5:.5;r.push({id:Date.now()+`_${e.role}_${a}`,role:e.role,model:e.model,coverage:e.coverage,x:s.x+o*i,y:s.y+n*i,rotation:t,h:300})}}i(e=>[...e,...r])})(o,{...r,t:{x:e,y:t}}),b(e=>{let t=e.roleIndex+1;return t>=e.queue.length?(f("select"),{...e,active:!1,roleIndex:0,step:0}):{...e,roleIndex:t,step:1,points:{p1:null,p2:null,t:null}}}))})(a,o);if("hand"===g||2===e.button){Z(!0),Q({x:s-A.x,y:l-A.y});return}let n=r.find(e=>1>Math.sqrt((a-e.x)**2+(o-e.y)**2));if(n){if(2===e.button){eN({x:s,y:l,id:n.id}),E(n.id);return}eM(),E(n.id),et(!0),J({x:a-n.x,y:o-n.y})}else 2!==e.button&&E(null);2!==e.button&&eN(null)},onMouseMove:e=>{if(!ek.current)return;let t=ek.current.getBoundingClientRect(),l=e.clientX-t.left,a=e.clientY-t.top,o=(l-A.x)/A.k,n=(a-A.y)/A.k;if(M){let e=2*Math.PI*ea/343,t=0,s=0,i=0;if(r.forEach(l=>{let a=eS.find(e=>e.model===l.model);if(!a)return;i++;let r=Math.pow(10,(a.maxSpl||120)/20),d=a.coverage||90,c=o-l.x,x=n-l.y,h=Math.sqrt(c*c+x*x);if(h<.1)return;let m=Math.abs(Math.atan2(x,c)-((l.rotation||0)*Math.PI/180+Math.PI/2));for(;m>Math.PI;)m-=2*Math.PI;for(;m<-Math.PI;)m+=2*Math.PI;m=Math.abs(m);let p=0;ea>200&&((p=Math.log(.5)/Math.log(Math.cos(d/2*Math.PI/180)))<0||isNaN(p))&&(p=0);let b=r/h*Math.pow(Math.cos(Math.min(m,Math.PI/2)),p),u=e*h;"direct"===en?t+=b*b:(t+=b*Math.cos(u),s+=b*Math.sin(u))}),i>0){let e=0;e="direct"===en?20*Math.log10(Math.sqrt(t)+1e-6):20*Math.log10(Math.sqrt(t*t+s*s)+1e-6),"snr"===en&&(e-=ec),eo({x:l,y:a,spl:e})}}else ei&&eo(null);if(p.active){ek.current.style.cursor="crosshair";return}let d=r.find(e=>1>Math.sqrt((o-e.x)**2+(n-e.y)**2));if(O(d?d.id:null),ek.current.style.cursor=d?"move":"hand"===g||Y?"grabbing":"default",Y)return void F(e=>({...e,x:l-X.x,y:a-X.y}));if(ee&&L&&"select"===g){let e=.1*Math.round((o-K.x)/.1),t=.1*Math.round((n-K.y)/.1);e<.5?e=0:e>s.roomWidth-.5&&(e=s.roomWidth),t<.5?t=0:t>s.roomDepth-.5&&(t=s.roomDepth),i(s=>s.map(s=>s.id===L?{...s,x:e,y:t}:s))}},onMouseUp:ez,onMouseLeave:ez,onContextMenu:e=>e.preventDefault(),className:"w-full h-full"})]}),(0,t.jsx)("div",{className:"fixed bottom-8 right-8 z-50",children:(0,t.jsxs)("button",{onClick:()=>{S(!1),setTimeout(()=>{let e=ek.current?.toDataURL("image/png");S(!0),el("high"),setTimeout(()=>{let t=ek.current?.toDataURL("image/png");S(M),a(s=>({...s,layoutImage:e,simImage:t})),d(4)},300)},100)},className:"bg-orange-600 hover:bg-orange-500 text-white pl-6 pr-4 py-4 rounded-full font-bold shadow-2xl flex gap-2",children:[m("si.deploy.next")," ",(0,t.jsx)(u.ChevronRight,{})]})})]})}let Y=({bom:e,compact:s})=>{let l=(Array.isArray(e)?e:[]).filter(e=>!e.category.includes("Speaker")&&!e.category.includes("音響")).flatMap(e=>{let t=e.u||(e.category.includes("Amp")?2:1);return Array(e.qty).fill(null).map((s,l)=>({...e,u:t,instanceId:`${e.id}-${l}`}))}),a=e=>e.includes("Amp")?3:e.includes("Processor")||e.includes("Mixer")?2:1;l.sort((e,t)=>a(e.category)-a(t.category));let r=[],i=[],o=0;return l.forEach(e=>{o+e.u>18&&(r.push({items:i,totalU:o}),i=[],o=0),i.push(e),o+=e.u}),i.length>0&&r.push({items:i,totalU:o}),0===r.length&&r.push({items:[],totalU:0}),(0,t.jsx)("div",{className:`flex gap-4 p-4 justify-center items-start ${s?"flex-wrap min-h-0":"overflow-x-auto min-h-[600px]"}`,children:r.map((e,s)=>(0,t.jsxs)("div",{className:"bg-[#0a0a0a] border-x-[6px] border-[#222] w-full max-w-[300px] relative shadow-2xl p-1 px-6 min-h-[580px] shrink-0",children:[(0,t.jsx)("div",{className:"absolute left-2 top-0 bottom-0 w-3 bg-[#1a1a1a] border-r border-[#333] z-10 flex flex-col justify-start pt-2 gap-[26px]",children:[...Array(18)].map((e,s)=>(0,t.jsx)("div",{className:"w-1 h-1 bg-black rounded-full mx-auto"},s))}),(0,t.jsx)("div",{className:"absolute right-2 top-0 bottom-0 w-3 bg-[#1a1a1a] border-l border-[#333] z-10 flex flex-col justify-start pt-2 gap-[26px]",children:[...Array(18)].map((e,s)=>(0,t.jsx)("div",{className:"w-1 h-1 bg-black rounded-full mx-auto"},s))}),(0,t.jsx)("div",{className:"absolute left-0 top-0 bottom-0 w-6 flex flex-col justify-start pt-1 gap-[18px] text-[8px] text-slate-600 font-mono text-center",children:[...Array(18)].map((e,s)=>(0,t.jsx)("div",{className:"leading-[12px]",children:s+1},s))}),(0,t.jsxs)("div",{className:"absolute top-[-25px] left-0 w-full text-center text-[10px] text-slate-500 font-bold tracking-widest uppercase",children:["RACK ",String(s+1).padStart(2,"0")]}),(0,t.jsxs)("div",{className:"flex flex-col justify-start h-full pt-2",children:[e.items.map((e,s)=>(0,t.jsxs)("div",{className:"w-full relative group/item border-t border-slate-600 border-b border-black bg-gradient-to-b from-slate-700 to-slate-800 flex items-center px-4 shadow-sm",style:{height:`${30*e.u}px`},children:[(0,t.jsx)("div",{className:"absolute left-0 top-0 bottom-0 w-1 bg-black/50"}),(0,t.jsx)("div",{className:"absolute right-0 top-0 bottom-0 w-1 bg-black/50"}),(0,t.jsxs)("div",{className:"flex-1 flex justify-between items-center text-xs overflow-hidden",children:[(0,t.jsxs)("span",{className:"font-bold text-slate-300 truncate",children:[e.brand," ",e.model]}),(0,t.jsxs)("div",{className:"flex gap-2 items-center shrink-0",children:[e.category.includes("Amp")&&(0,t.jsx)("div",{className:"text-[10px] text-orange-400 font-mono",children:"PWR"}),(0,t.jsx)("div",{className:"w-1.5 h-1.5 bg-blue-500 rounded-full shadow-[0_0_5px_blue] animate-pulse"})]})]}),(0,t.jsx)("div",{className:"absolute left-1 top-1/2 -translate-y-1/2 w-1.5 h-1.5 bg-slate-400 rounded-full shadow-inner border border-black"}),(0,t.jsx)("div",{className:"absolute right-1 top-1/2 -translate-y-1/2 w-1.5 h-1.5 bg-slate-400 rounded-full shadow-inner border border-black"})]},s)),(0,t.jsx)("div",{className:"flex-1 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPjxyZWN0IHdpZHRoPSI0IiBoZWlnaHQ9IjQiIGZpbGw9IiMxMTEiLz48cmVjdCB5PSIyIiB3aWR0aD0iNCIgaGVpZ2h0PSIxIiBmaWxsPSIjMjIyIi8+PC9zdmc+')] opacity-20 border-t border-slate-800 h-full border-b border-slate-800",style:{height:`${(18-e.totalU)*30}px`}})]})]},s))})},Z=({bom:e})=>{let s=e.filter(e=>!e.category.includes("Speaker")&&!e.category.includes("音響")).flatMap(e=>{let t=e.u||(e.category.includes("Amp")?2:1);return Array(e.qty).fill(null).map((s,l)=>({...e,u:t,instanceId:`${e.id}-${l}`}))}),[a,r]=(0,l.useState)({}),i=(0,l.useRef)({});(0,l.useEffect)(()=>{let e=()=>{let e={};Object.keys(i.current).forEach(t=>{let s=i.current[t];if(s){let l=s.getBoundingClientRect(),a=s.closest(".port-container");if(a){let s=a.getBoundingClientRect();e[t]={x:l.left-s.left+l.width/2,y:l.top-s.top+l.height/2}}}}),r(e)};e();let t=setTimeout(e,500);return window.addEventListener("resize",e),()=>{window.removeEventListener("resize",e),clearTimeout(t)}},[e]);let o=e=>e.includes("Amp")?3:e.includes("Processor")||e.includes("Mixer")?2:1;s.sort((e,t)=>o(e.category)-o(t.category));let n=[{title:"點位連接 (INPUT)",items:s.filter(e=>e.category.includes("Mic")||e.category.includes("Source")),color:"from-blue-500 to-cyan-500",id:"col-in"},{title:"混合器處理 (MIXER/DSP)",items:[...s.filter(e=>e.category.includes("Mixer")),...s.filter(e=>e.category.includes("Processor"))],color:"from-purple-500 to-pink-500",id:"col-dsp"},{title:"編組處理 (AMP)",items:s.filter(e=>e.category.includes("Amp")),color:"from-orange-500 to-red-500",id:"col-amp"},{title:"揚聲群輸出 (OUTPUT)",items:e.filter(e=>e.category.includes("Speaker")||e.category.includes("音響")),color:"from-green-500 to-emerald-500",id:"col-out"}];return(0,t.jsxs)("div",{className:"relative z-10 port-container w-full h-full min-h-[500px]",children:[(0,t.jsxs)("svg",{className:"absolute top-0 left-0 w-full h-full pointer-events-none -z-10",children:[(0,t.jsx)("defs",{children:(0,t.jsxs)("linearGradient",{id:"flowGrad",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[(0,t.jsx)("stop",{offset:"0%",stopColor:"#3b82f6",opacity:"0.6"}),(0,t.jsx)("stop",{offset:"100%",stopColor:"#10b981",opacity:"0.6"})]})}),Object.keys(a).length>0&&n.map((e,s)=>s===n.length-1?null:e.items.map((e,l)=>{let r=`item-${s}-${l}-out`,i=a[r];return i?n[s+1].items.map((l,o)=>{let n=`item-${s+1}-${o}-in`,d=a[n];if(!d||1===s&&l.systemRole!==e.systemRole&&!e.category.includes("Mixer")||2===s&&l.systemRole!==e.systemRole)return null;let c=Math.abs(d.x-i.x),x=i.x+.4*c,h=d.x-.4*c,m=`M ${i.x} ${i.y} C ${x} ${i.y} ${h} ${d.y} ${d.x} ${d.y}`;return(0,t.jsxs)("g",{children:[(0,t.jsx)("path",{d:m,stroke:"rgba(59, 130, 246, 0.1)",strokeWidth:"1",fill:"none"}),(0,t.jsx)("path",{d:m,stroke:"url(#flowGrad)",strokeWidth:"2",fill:"none",strokeDasharray:"4,8",className:"animate-[dash_20s_linear_infinite]"})]},`${r}-${n}`)}):null}))]}),(0,t.jsx)("div",{className:"grid grid-cols-4 gap-4 h-full relative z-10",children:n.map((e,s)=>(0,t.jsxs)("div",{className:"flex flex-col gap-4 relative",children:[(0,t.jsx)("h4",{className:"text-[10px] font-bold text-slate-500 uppercase text-center mb-2 no-print",children:e.title}),(0,t.jsxs)("div",{className:"flex-1 flex flex-col justify-center gap-4",children:[0===e.items.length&&(0,t.jsx)("div",{className:"text-slate-700 text-[10px] text-center italic",children:"無設備"}),e.items.map((l,a)=>{let r=`item-${s}-${a}`;return(0,t.jsxs)("div",{className:"bg-slate-800 border border-slate-700 p-2 rounded-lg shadow-lg relative z-10 flex flex-col gap-0.5 group",children:[(0,t.jsx)("div",{className:`absolute top-0 left-0 w-0.5 h-full rounded-l-lg bg-gradient-to-b ${e.color}`}),(0,t.jsx)("div",{className:"font-bold text-[10px] text-white truncate pl-1",children:l.model}),(0,t.jsx)("div",{className:"text-[8px] text-slate-500 pl-1",children:l.brand}),s>0&&(0,t.jsx)("div",{ref:e=>{i.current[`${r}-in`]=e},className:"absolute top-1/2 -left-1 w-2 h-2 bg-slate-900 border border-slate-500 rounded-full"}),s<n.length-1&&(0,t.jsx)("div",{ref:e=>{i.current[`${r}-out`]=e},className:"absolute top-1/2 -right-1 w-2 h-2 bg-slate-900 border border-slate-500 rounded-full group-hover:bg-blue-500 transition-colors"})]},a)})]})]},s))})]})};function X({bom:e,projectInfo:s,setPhase:l,t:a}){return(0,t.jsxs)("div",{className:"grid grid-cols-1 xl:grid-cols-3 gap-8 animate-in slide-in-from-bottom-8 fade-in h-screen pb-40 overflow-y-auto pr-4",children:[(0,t.jsxs)("div",{className:"xl:col-span-1 bg-slate-900/80 backdrop-blur-xl border border-slate-700/50 rounded-2xl p-6 shadow-2xl relative overflow-hidden h-fit",children:[(0,t.jsx)("div",{className:"absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-orange-500 to-purple-600"}),(0,t.jsxs)("h3",{className:"text-xl font-bold text-white mb-6 flex items-center gap-3",children:[(0,t.jsx)(r.Server,{className:"text-orange-400"})," ",a("si.diagram.cabinet")]}),(0,t.jsx)(Y,{bom:e,compact:!1})]}),(0,t.jsxs)("div",{className:"xl:col-span-2 bg-slate-900/80 backdrop-blur-xl border border-slate-700/50 rounded-2xl p-6 shadow-2xl relative h-fit",children:[(0,t.jsxs)("h3",{className:"text-xl font-bold text-white mb-6 flex items-center gap-3",children:[(0,t.jsx)(i.Activity,{className:"text-blue-400"})," ",a("si.diagram.flow")]}),(0,t.jsx)(Z,{bom:e,t:a})]}),(0,t.jsx)("div",{className:"fixed bottom-8 right-8 z-50",children:(0,t.jsxs)("button",{onClick:()=>l(5),className:"bg-orange-600 hover:bg-orange-500 text-white pl-6 pr-4 py-4 rounded-full font-bold shadow-2xl flex gap-2 transition-all hover:scale-110",children:[a("si.diagram.next")," ",(0,t.jsx)(u.ChevronRight,{})]})})]})}function Q({bom:e,reportSettings:s,setReportSettings:l,setPhase:a,t:r}){let i=e.reduce((e,t)=>e+t.unitPrice*t.qty,0),o=(s.laborDays||0)*(s.laborPrice||0),n=i*((s.consumablesRate||0)/100),d=i+o+n,c=d*(s.margin/100),x=d+c,h=x*(s.taxRate/100);return(0,t.jsxs)("div",{className:"max-w-4xl mx-auto animate-in slide-in-from-right-8 fade-in pt-10 pb-40",children:[(0,t.jsxs)("div",{className:"bg-slate-900/80 backdrop-blur-xl border border-slate-700/50 rounded-2xl p-10 shadow-2xl relative",children:[(0,t.jsx)("div",{className:"absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-green-500 to-blue-600"}),(0,t.jsxs)("h3",{className:"text-2xl font-bold text-white mb-8 flex items-center gap-3",children:[(0,t.jsx)(g,{className:"text-green-400",size:32})," ",r("si.quote.title")]}),(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-12",children:[(0,t.jsxs)("div",{className:"space-y-6",children:[(0,t.jsxs)("div",{className:"p-6 bg-slate-800/50 rounded-xl border border-slate-700/50",children:[(0,t.jsx)("label",{className:"text-xs text-slate-400 font-bold block mb-4 uppercase tracking-wider",children:r("si.quote.margin")}),(0,t.jsxs)("div",{className:"flex items-center gap-4 mb-4",children:[(0,t.jsxs)("span",{className:"text-2xl font-bold text-white w-20",children:[s.margin,"%"]}),(0,t.jsx)("input",{type:"range",min:"0",max:"100",step:"1",value:s.margin,onChange:e=>l({...s,margin:Number(e.target.value)}),className:"flex-1 h-1.5 bg-slate-700 rounded-lg accent-orange-500"})]}),(0,t.jsx)("label",{className:"text-xs text-slate-400 font-bold block mb-4 uppercase tracking-wider",children:r("si.quote.tax")}),(0,t.jsxs)("div",{className:"flex items-center gap-4",children:[(0,t.jsxs)("span",{className:"text-2xl font-bold text-white w-20",children:[s.taxRate,"%"]}),(0,t.jsx)("input",{type:"range",min:"0",max:"25",step:"1",value:s.taxRate,onChange:e=>l({...s,taxRate:Number(e.target.value)}),className:"flex-1 h-1.5 bg-slate-700 rounded-lg accent-blue-500"})]})]}),(0,t.jsxs)("div",{className:"p-6 bg-slate-800/50 rounded-xl border border-slate-700/50",children:[(0,t.jsx)("h4",{className:"text-xs font-bold text-orange-500 uppercase mb-4 tracking-widest",children:"工程及技術人工 (Engineering Labor)"}),(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"text-[10px] text-slate-500 block mb-1",children:"預估工期 (天數)"}),(0,t.jsx)("input",{type:"number",value:s.laborDays,onChange:e=>l({...s,laborDays:Number(e.target.value)}),className:"w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-white font-mono"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"text-[10px] text-slate-500 block mb-1",children:"單日單價 (元/天)"}),(0,t.jsx)("input",{type:"number",value:s.laborPrice,onChange:e=>l({...s,laborPrice:Number(e.target.value)}),className:"w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-white font-mono"})]})]}),(0,t.jsxs)("div",{className:"mt-3 text-right text-xs text-slate-400",children:["人工小計: ",(0,t.jsxs)("span",{className:"text-white font-bold",children:["$",o.toLocaleString()]})]})]}),(0,t.jsxs)("div",{className:"p-6 bg-slate-800/50 rounded-xl border border-slate-700/50",children:[(0,t.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,t.jsx)("h4",{className:"text-xs font-bold text-blue-400 uppercase tracking-widest",children:"耗材與線材 (Consumables)"}),(0,t.jsxs)("span",{className:"text-lg font-bold text-white",children:[s.consumablesRate,"%"]})]}),(0,t.jsx)("input",{type:"range",min:"0",max:"50",step:"1",value:s.consumablesRate,onChange:e=>l({...s,consumablesRate:Number(e.target.value)}),className:"w-full h-1.5 bg-slate-700 rounded-lg accent-blue-400 mb-2"}),(0,t.jsxs)("p",{className:"text-[10px] text-slate-500 italic",children:["依設備總價 ",i.toLocaleString()," 計取"]}),(0,t.jsxs)("div",{className:"mt-2 text-right text-xs text-slate-400",children:["耗材小計: ",(0,t.jsxs)("span",{className:"text-white font-bold",children:["$",n.toLocaleString()]})]})]})]}),(0,t.jsxs)("div",{className:"space-y-4 flex flex-col justify-center border-l border-slate-800 pl-12",children:[(0,t.jsxs)("div",{className:"flex justify-between items-end border-b border-slate-800 pb-2",children:[(0,t.jsx)("div",{className:"text-[10px] text-slate-500 uppercase font-black tracking-widest",children:r("si.quote.base")}),(0,t.jsx)("div",{className:"text-xl font-mono text-slate-300",children:_(i)})]}),(0,t.jsxs)("div",{className:"flex justify-between items-end border-b border-slate-800 pb-2",children:[(0,t.jsx)("div",{className:"text-[10px] text-slate-500 uppercase font-black tracking-widest",children:"技術人工 (Labor)"}),(0,t.jsx)("div",{className:"text-xl font-mono text-slate-300",children:_(o)})]}),(0,t.jsxs)("div",{className:"flex justify-between items-end border-b border-slate-800 pb-2",children:[(0,t.jsx)("div",{className:"text-[10px] text-slate-500 uppercase font-black tracking-widest",children:"耗材雜項 (Misc)"}),(0,t.jsx)("div",{className:"text-xl font-mono text-slate-300",children:_(n)})]}),(0,t.jsxs)("div",{className:"flex justify-between items-end border-b border-slate-800 pb-2",children:[(0,t.jsxs)("div",{className:"text-[10px] text-slate-500 uppercase font-black tracking-widest flex items-center gap-2",children:[r("si.quote.profit")," ",(0,t.jsxs)("span",{className:"text-green-500 text-[10px] px-2 py-0.5 bg-green-900/30 rounded",children:["+",s.margin,"%"]})]}),(0,t.jsx)("div",{className:"text-xl font-mono text-green-400",children:_(c)})]}),(0,t.jsxs)("div",{className:"flex justify-between items-end border-b border-slate-800 pb-2",children:[(0,t.jsxs)("div",{className:"text-[10px] text-slate-500 uppercase font-black tracking-widest flex items-center gap-2",children:[r("si.quote.taxAmount")," ",(0,t.jsxs)("span",{className:"text-blue-500 text-[10px] px-2 py-0.5 bg-blue-900/30 rounded",children:["+",s.taxRate,"%"]})]}),(0,t.jsx)("div",{className:"text-xl font-mono text-blue-400",children:_(h)})]}),(0,t.jsxs)("div",{className:"pt-6",children:[(0,t.jsx)("div",{className:"text-sm text-orange-500 uppercase font-black tracking-widest mb-1",children:r("si.quote.total")}),(0,t.jsx)("div",{className:"text-5xl font-black font-mono text-white tracking-tighter",children:_(x+h)})]})]})]}),(0,t.jsx)("div",{className:"mt-12 flex justify-end",children:(0,t.jsxs)("button",{onClick:()=>a(6),className:"bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-500 hover:to-red-500 text-white px-8 py-4 rounded-xl font-bold shadow-2xl flex items-center gap-3 transition-all hover:scale-105",children:[(0,t.jsx)(b.FileText,{size:20})," ",r("si.quote.generate")," ",(0,t.jsx)(u.ChevronRight,{})]})})]}),(0,t.jsx)("div",{className:"fixed bottom-8 right-8 z-50",children:(0,t.jsxs)("button",{onClick:()=>a(4),className:"bg-slate-800 hover:bg-slate-700 text-slate-300 pl-4 pr-6 py-4 rounded-full font-bold shadow-xl flex gap-2",children:[" ",(0,t.jsx)(I,{})," ",r("si.quote.back")]})})]})}function K({projectInfo:e,setProjectInfo:s,bom:l,setBom:a,reportSettings:o,setPhase:n,canvasObjects:d}){if(!l||0===l.length)return(0,t.jsx)("div",{className:"max-w-5xl mx-auto pt-20 pb-20 animate-in fade-in",children:(0,t.jsxs)("div",{className:"bg-slate-900 border border-slate-700 rounded-2xl p-12 text-center shadow-2xl",children:[(0,t.jsx)("div",{className:"w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-6",children:(0,t.jsx)(b.FileText,{size:40,className:"text-slate-500"})}),(0,t.jsx)("h2",{className:"text-3xl font-bold text-white mb-4",children:"工程報表無數據"}),(0,t.jsx)("p",{className:"text-slate-400 mb-8 max-w-md mx-auto",children:"目前清單中沒有設備。您可以返回並添加設備，或直接載入演示數據以預覽報表效果。"}),(0,t.jsx)("div",{className:"flex gap-4 justify-center",children:(0,t.jsxs)("button",{onClick:()=>n(2),className:"bg-slate-800 hover:bg-slate-700 text-white px-8 py-4 rounded-xl font-bold flex items-center gap-2 border border-slate-700",children:["返回添加設備 ",(0,t.jsx)(u.ChevronRight,{size:20})]})})]})});let{margin:c,taxRate:x}=o||{margin:20,taxRate:5},h=l.reduce((e,t)=>e+t.unitPrice*t.qty,0),m=h*(1+c/100),g=Array.from(new Set(l.map(e=>e.category))),j=l.filter(e=>e.category.includes("Speaker")||e.category.includes("音響")).reduce((e,t)=>e+(t.power||400)*t.qty,0),v=l.filter(e=>"Main PA"===e.systemRole).reduce((e,t)=>Math.max(e,t.maxSpl||125),0),y=(o.laborDays||0)*(o.laborPrice||0),N=h*((o.consumablesRate||0)/100),k=(j/110).toFixed(1),M=(j/220).toFixed(1);return(0,t.jsx)("div",{className:"max-w-5xl mx-auto space-y-6 pt-6 pb-20 animate-in fade-in",children:(0,t.jsxs)("div",{className:"bg-slate-900 border border-slate-700 rounded-2xl p-8 shadow-2xl relative overflow-hidden",children:[(0,t.jsx)("div",{className:"absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-orange-500 via-red-600 to-indigo-600"}),(0,t.jsxs)("div",{className:"flex justify-between items-start mb-10",children:[(0,t.jsxs)("div",{className:"flex items-center gap-4",children:[(0,t.jsx)("button",{onClick:()=>n(5),className:"p-2 hover:bg-white/10 rounded-full transition-colors group",title:"返回上一步",children:(0,t.jsx)(A,{className:"text-slate-400 group-hover:text-white",size:24})}),(0,t.jsx)("div",{className:"p-3 bg-orange-600 rounded-xl shadow-lg shadow-orange-900/40",children:(0,t.jsx)(b.FileText,{size:32,className:"text-white"})}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h2",{className:"text-3xl font-bold tracking-tighter text-white",children:"ENGINEERING REPORT"}),(0,t.jsxs)("p",{className:"text-sm text-slate-500 font-mono",children:["ID: ",Date.now().toString(36).toUpperCase()," | ",new Date().toLocaleDateString()]})]})]}),(0,t.jsxs)("div",{className:"text-right",children:[(0,t.jsx)("div",{className:"text-xs text-slate-500 uppercase font-bold tracking-widest mb-1",children:"專案總報價 (Grand Total)"}),(0,t.jsxs)("div",{className:"text-4xl font-black text-orange-500 font-mono tracking-tighter",children:["$",(m+x/100*m).toLocaleString(void 0,{maximumFractionDigits:0})]})]})]}),(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6 mb-10",children:[(0,t.jsxs)("div",{className:"bg-slate-800/50 p-4 rounded-xl border border-slate-700/50",children:[(0,t.jsx)("label",{className:"text-xs text-slate-500 block mb-2 font-bold uppercase tracking-wider",children:"專案規模 (Scale)"}),(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsx)("div",{className:"text-sm font-bold text-white truncate",children:e.name||"未命名專案"}),(0,t.jsxs)("div",{className:"text-xs text-slate-400 font-mono",children:[e.roomWidth,"m × ",e.roomDepth,"m | ",l.length," Items"]})]})]}),(0,t.jsxs)("div",{className:"bg-slate-800/50 p-4 rounded-xl border border-slate-700/50",children:[(0,t.jsx)("label",{className:"text-xs text-slate-500 block mb-2 font-bold uppercase tracking-wider",children:"費用構成 (Fee Breakdown)"}),(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-x-4 gap-y-1 text-[10px]",children:[(0,t.jsx)("span",{className:"text-slate-500",children:"設備總價:"}),(0,t.jsxs)("span",{className:"text-slate-300 font-mono text-right",children:["$",h.toLocaleString()]}),(0,t.jsx)("span",{className:"text-slate-500",children:"工程人工:"}),(0,t.jsxs)("span",{className:"text-slate-300 font-mono text-right",children:["$",y.toLocaleString()]}),(0,t.jsx)("span",{className:"text-slate-500",children:"線材耗材:"}),(0,t.jsxs)("span",{className:"text-slate-300 font-mono text-right",children:["$",N.toLocaleString()]})]})]}),(0,t.jsxs)("div",{className:"bg-slate-800/50 p-4 rounded-xl border border-slate-700/50",children:[(0,t.jsx)("label",{className:"text-xs text-slate-500 block mb-2 font-bold uppercase tracking-wider",children:"電力與聲壓 (Power & SPL)"}),(0,t.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,t.jsxs)("div",{className:"flex flex-col",children:[(0,t.jsxs)("span",{className:"text-sm font-bold text-white font-mono",children:[j,"W"]}),(0,t.jsx)("span",{className:"text-[9px] text-slate-500 uppercase",children:"總功率"})]}),(0,t.jsxs)("div",{className:"flex flex-col",children:[(0,t.jsxs)("span",{className:"text-sm font-bold text-orange-500 font-mono",children:[v,"dB"]}),(0,t.jsx)("span",{className:"text-[9px] text-slate-500 uppercase",children:"峰值SPL"})]})]}),(0,t.jsxs)("div",{className:"mt-2 pt-2 border-t border-slate-700 flex justify-between text-[10px] font-mono",children:[(0,t.jsxs)("span",{className:"text-slate-500",children:["110V: ",(0,t.jsxs)("span",{className:"text-blue-400",children:[k,"A"]})]}),(0,t.jsxs)("span",{className:"text-slate-500",children:["220V: ",(0,t.jsxs)("span",{className:"text-emerald-400",children:[M,"A"]})]})]})]})]}),(0,t.jsxs)("div",{className:"space-y-6 mb-10 print:space-y-4",children:[(0,t.jsxs)("div",{className:"bg-slate-800/50 rounded-2xl border border-slate-700/50 overflow-hidden print:break-inside-avoid print:border-slate-800 print:shadow-none",children:[(0,t.jsx)("div",{className:"p-4 border-b border-slate-700 bg-slate-800/80 flex justify-between items-center print:bg-slate-900 print:text-black",children:(0,t.jsxs)("h4",{className:"text-xs font-bold text-white print:text-black uppercase tracking-wider flex items-center gap-2",children:[(0,t.jsx)(p,{size:14})," 設備佈署點位 (Deployment Layout)"]})}),(0,t.jsx)("div",{className:"h-[450px] relative",children:(0,t.jsx)(J,{projectInfo:e,canvasObjects:d,mode:"layout"})})]}),e.simSnapshots&&e.simSnapshots.length>0&&(0,t.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:e.simSnapshots.map((e,s)=>(0,t.jsxs)("div",{className:"bg-slate-800/50 rounded-2xl border border-slate-700/50 overflow-hidden print:break-inside-avoid",children:[(0,t.jsx)("div",{className:"p-4 border-b border-slate-700 bg-slate-800/80 flex justify-between items-center print:bg-slate-900 print:text-black",children:(0,t.jsxs)("h4",{className:"text-xs font-bold text-white print:text-black uppercase tracking-wider flex items-center gap-2",children:[(0,t.jsx)(R,{size:14})," 聲學物理模擬 - ",e.freq,"Hz (",e.mode,")"]})}),(0,t.jsx)("div",{className:"relative aspect-[4/3] bg-black",children:(0,t.jsx)("img",{src:e.dataUrl,className:"w-full h-full object-contain"})})]},s))})]}),(0,t.jsxs)("div",{className:"space-y-6 mb-10 print:break-before-page",children:[(0,t.jsxs)("div",{className:"bg-slate-800/50 rounded-2xl border border-slate-700/50 overflow-hidden print:break-inside-avoid",children:[(0,t.jsx)("div",{className:"p-4 border-b border-slate-700 bg-slate-800/80 print:bg-slate-900 print:text-black",children:(0,t.jsxs)("h4",{className:"text-xs font-bold text-white print:text-black uppercase tracking-wider flex items-center gap-2",children:[(0,t.jsx)(r.Server,{size:14})," 機櫃物理配置 (Rack Layout)"]})}),(0,t.jsx)("div",{className:"p-6 overflow-x-auto",children:(0,t.jsx)("div",{className:"min-w-[400px]",children:(0,t.jsx)(Y,{bom:l,compact:!0})})})]}),(0,t.jsxs)("div",{className:"bg-slate-800/50 rounded-2xl border border-slate-700/50 overflow-hidden print:break-inside-avoid",children:[(0,t.jsx)("div",{className:"p-4 border-b border-slate-700 bg-slate-800/80 print:bg-slate-900 print:text-black",children:(0,t.jsxs)("h4",{className:"text-xs font-bold text-white print:text-black uppercase tracking-wider flex items-center gap-2",children:[(0,t.jsx)(i.Activity,{size:14})," 系統訊號流程 (Signal Flow)"]})}),(0,t.jsx)("div",{className:"p-6 h-[500px] relative print:h-auto",children:(0,t.jsx)(Z,{bom:l})})]})]}),(0,t.jsx)("div",{className:"space-y-8",children:g.map(e=>(0,t.jsxs)("div",{className:"space-y-3 print:break-inside-avoid",children:[(0,t.jsxs)("h3",{className:"text-xs font-black text-slate-500 uppercase tracking-[0.2em] border-l-4 border-orange-500 pl-3 py-0.5",children:[e," 設備清單"]}),(0,t.jsx)("div",{className:"overflow-hidden rounded-xl border border-slate-800 print:border-slate-300",children:(0,t.jsxs)("table",{className:"w-full text-sm text-left",children:[(0,t.jsx)("thead",{className:"bg-slate-800/80 text-[10px] text-slate-400 uppercase font-bold tracking-widest border-b border-slate-700 print:bg-slate-100 print:text-black print:border-slate-300",children:(0,t.jsxs)("tr",{children:[(0,t.jsx)("th",{className:"px-4 py-2",children:"型號 (Model)"}),(0,t.jsx)("th",{className:"px-4 py-2",children:"角色"}),(0,t.jsx)("th",{className:"px-4 py-2 text-center",children:"數量"}),(0,t.jsx)("th",{className:"px-4 py-2 text-right",children:"單價"}),(0,t.jsx)("th",{className:"px-4 py-2 text-right",children:"小計"})]})}),(0,t.jsx)("tbody",{className:"divide-y divide-slate-800",children:l.filter(t=>t.category===e).map((e,s)=>(0,t.jsxs)("tr",{className:"hover:bg-slate-800/30 transition-colors",children:[(0,t.jsx)("td",{className:"px-4 py-3 font-medium text-white",children:(0,t.jsxs)("div",{children:[e.brand," ",e.model]})}),(0,t.jsx)("td",{className:"px-4 py-3 text-xs",children:(0,t.jsx)("span",{className:"bg-slate-700 px-2 py-0.5 rounded text-slate-300 font-bold tracking-tighter",children:e.systemRole})}),(0,t.jsx)("td",{className:"px-4 py-3 text-center text-white",children:e.qty}),(0,t.jsxs)("td",{className:"px-4 py-3 text-right text-slate-400 font-mono",children:["$",e.unitPrice.toLocaleString()]}),(0,t.jsxs)("td",{className:"px-4 py-3 text-right text-orange-400 font-bold font-mono",children:["$",(e.unitPrice*e.qty).toLocaleString()]})]},s))})]})})]},e))}),(0,t.jsxs)("div",{className:"mt-12 flex flex-wrap gap-4 no-print",children:[(0,t.jsxs)("button",{onClick:()=>window.print(),className:"flex-1 min-w-[200px] bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-4 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg hover:shadow-indigo-500/20 transition-all",children:[(0,t.jsx)(w,{size:20})," 列印完整報表 (PDF)"]}),(0,t.jsxs)("button",{onClick:()=>n(5),className:"bg-slate-700 hover:bg-slate-600 text-white px-8 py-4 rounded-xl font-bold flex items-center gap-2 border border-slate-600",children:[(0,t.jsx)(A,{size:20})," 返回上一步"]}),(0,t.jsxs)("button",{onClick:()=>n(1),className:"bg-slate-800 hover:bg-slate-700 text-white px-8 py-4 rounded-xl font-bold flex items-center gap-2 border border-slate-700",children:["返回首頁 ",(0,t.jsx)(f.RotateCcw,{size:20})]})]})]})})}function J({projectInfo:e,canvasObjects:s,mode:a}){let r=(0,l.useRef)(null),[i,o]=(0,l.useState)(null);return(0,l.useEffect)(()=>{if(e.bgImage){let t=new Image;t.src=e.bgImage,t.onload=()=>o(t)}else o(null)},[e.bgImage]),(0,l.useEffect)(()=>{let t=r.current;if(!t)return;let l=t.getContext("2d");if(!l)return;let o=t.parentElement;o&&(t.width=o.clientWidth,t.height=o.clientHeight);let n=e.roomWidth||20,d=e.roomDepth||15,c=Math.min((t.width-40)/n,(t.height-40)/d),x=(t.width-n*c)/2,h=(t.height-d*c)/2;l.fillStyle="heatmap"===a?"#0f172a":"#ffffff",l.fillRect(0,0,t.width,t.height),l.save(),l.translate(x,h),l.scale(c,c),i?(l.drawImage(i,0,0,n,d),"heatmap"===a&&(l.fillStyle="rgba(15, 23, 42, 0.4)",l.fillRect(0,0,n,d))):(l.fillStyle="heatmap"===a?"#1e293b":"#f1f5f9",l.fillRect(0,0,n,d)),l.strokeStyle="heatmap"===a?"rgba(255,255,255,0.1)":"#cbd5e1",l.lineWidth=.05,l.strokeRect(0,0,n,d),l.beginPath();for(let e=0;e<=n;e++)l.moveTo(e,0),l.lineTo(e,d);for(let e=0;e<=d;e++)l.moveTo(0,e),l.lineTo(n,e);l.stroke(),"heatmap"===a&&(l.globalCompositeOperation="screen",(s||[]).forEach(e=>{let t=(e.model||"").toLowerCase().includes("sub"),s=(e.coverage||90)/2*Math.PI/180,a=t?15:20,r=l.createRadialGradient(e.x,e.y,0,e.x,e.y,a);t?r.addColorStop(0,"rgba(168, 85, 247, 0.8)"):(r.addColorStop(0,"rgba(239, 68, 68, 0.8)"),r.addColorStop(.5,"rgba(234, 179, 8, 0.5)")),r.addColorStop(1,"rgba(0,0,0,0)"),l.fillStyle=r,l.beginPath(),l.moveTo(e.x,e.y);let i=(e.rotation||0)*Math.PI/180;l.arc(e.x,e.y,a,i-s+Math.PI/2,i+s+Math.PI/2),l.fill()}),l.globalCompositeOperation="source-over"),(s||[]).forEach(e=>{l.save(),l.translate(e.x,e.y);let t="#f97316",s=e.role||"Main PA";"Stage Monitor"===s?t="#22c55e":"Subwoofer"===s?t="#a855f7":"Delay"===s?t="#06b6d4":"Front Fill"===s&&(t="#eab308"),l.fillStyle="heatmap"===a?"#fff":t,l.strokeStyle="heatmap"===a?"#000":"#fff",l.lineWidth=.05,l.beginPath(),l.arc(0,0,.4,0,2*Math.PI),l.fill(),l.stroke(),void 0!==e.rotation&&(l.rotate(e.rotation*Math.PI/180),l.strokeStyle="heatmap"===a?"#fff":"#000",l.lineWidth=.05,l.beginPath(),l.moveTo(0,0),l.lineTo(0,.8),l.stroke()),l.restore()}),l.restore()},[e,s,a,i]),(0,t.jsx)("canvas",{ref:r,className:"w-full h-full"})}e.s(["default",()=>H],29205)}]);